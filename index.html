<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Scribble War - Progress Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        body {
            background: linear-gradient(180deg, #0a0a0f 0%, #0d0d15 50%, #0a0a0f 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: #fff;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Main Layout - Split View - ALWAYS HORIZONTAL */
        .container {
            display: flex;
            flex-direction: row !important;
            flex-wrap: nowrap;
            width: 100vw;
            height: 100vh;
            gap: 0;
        }

        /* Main Game Area - Left Side */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px 15px;
            overflow: hidden;
            max-width: 65%;
            min-width: 0;
        }

        .game-title {
            text-align: center;
            margin-bottom: 4px;
        }

        .game-title h1 {
            font-size: 20px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-subtitle {
            color: #666;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 1px;
        }

        /* Vertical Pill Layout */
        .cards-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            justify-content: center;
            padding: 2px 10px;
            width: 100%;
        }

        /* Country Card - Horizontal Row */
        .country-card {
            background: transparent;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }

        .country-card:active {
            transform: scale(0.98);
        }

        .country-card.selected .progress-container {
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.6);
        }

        .country-card.sabotaged {
            animation: sabotageShake 0.5s ease;
        }

        .country-card.sabotaged .progress-container {
            animation: sabotageFlash 0.5s ease;
        }

        @keyframes sabotageShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        @keyframes sabotageFlash {
            0%, 100% { box-shadow: var(--default-shadow); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.9), inset 0 0 20px rgba(255, 0, 0, 0.5); }
        }

        /* Country Name Label - Hidden, name now inside bar */
        .country-label {
            display: none;
        }

        .country-name {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .boost-emoji {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Progress Bar - Pill Shape - Dark Background */
        .progress-container {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            --default-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
            box-shadow: var(--default-shadow), inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Country name inside bar */
        .bar-country-name {
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            z-index: 2;
            pointer-events: none;
        }

        .bar-boost-emoji {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.7;
            z-index: 2;
            pointer-events: none;
        }

        /* Progress Fill - Neon Glow */
        .progress-fill {
            height: 100%;
            width: 0%;
            min-width: 45px;
            border-radius: 50px;
            position: relative;
            transition: width 0.5s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            background: linear-gradient(90deg, var(--country-color), var(--country-color-light, var(--country-color)));
            box-shadow: 
                0 0 20px var(--country-glow),
                0 0 40px var(--country-glow),
                inset 0 2px 10px rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow: visible;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, transparent 100%);
            border-radius: 50px 50px 0 0;
        }

        /* EPIC Green Glow when moving - Regular moves */
        .progress-fill.moving {
            animation: epicGreenPulse 0.6s ease;
        }

        @keyframes epicGreenPulse {
            0% { 
                box-shadow: 
                    0 0 20px var(--country-glow),
                    0 0 40px var(--country-glow),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
                filter: brightness(1);
            }
            25% { 
                box-shadow: 
                    0 0 40px #00ff00,
                    0 0 80px #00ff00,
                    0 0 120px rgba(0, 255, 0, 0.8),
                    0 0 160px rgba(0, 255, 0, 0.5),
                    inset 0 0 30px rgba(0, 255, 0, 0.6);
                filter: brightness(1.4) saturate(1.5);
                transform: scaleY(1.15);
            }
            50% { 
                box-shadow: 
                    0 0 50px #00ff88,
                    0 0 100px #00ff44,
                    0 0 150px rgba(0, 255, 100, 0.9),
                    0 0 200px rgba(0, 255, 0, 0.6),
                    inset 0 0 40px rgba(0, 255, 0, 0.7);
                filter: brightness(1.6) saturate(1.8);
                transform: scaleY(1.2) scaleX(1.02);
            }
            75% {
                box-shadow: 
                    0 0 35px #00ff00,
                    0 0 70px rgba(0, 255, 0, 0.7),
                    inset 0 0 20px rgba(0, 255, 0, 0.4);
                filter: brightness(1.3);
                transform: scaleY(1.1);
            }
            100% { 
                box-shadow: 
                    0 0 20px var(--country-glow),
                    0 0 40px var(--country-glow),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
                filter: brightness(1);
                transform: scaleY(1) scaleX(1);
            }
        }

        /* MEGA BOOST - Extreme shake, glow, and 3D pop effect */
        .progress-fill.boosting {
            animation: megaBoostExtreme 1s cubic-bezier(0.36, 0.07, 0.19, 0.97);
        }

        @keyframes megaBoostExtreme {
            0% { 
                transform: scale(1) translateZ(0);
                box-shadow: 0 0 20px var(--country-glow);
                filter: brightness(1);
            }
            5% { transform: scale(1.05) translateX(-8px) translateY(-2px); }
            10% { transform: scale(1.1) translateX(8px) translateY(2px); }
            15% { transform: scale(1.08) translateX(-10px) translateY(-3px); }
            20% { transform: scale(1.15) translateX(10px) translateY(3px); }
            25% { 
                transform: scale(1.2) translateX(-6px) translateY(-4px) perspective(500px) translateZ(50px);
                box-shadow: 
                    0 0 60px #00ff00,
                    0 0 120px #00ff00,
                    0 0 180px rgba(0, 255, 0, 1),
                    0 0 250px rgba(0, 255, 0, 0.8),
                    0 20px 60px rgba(0, 0, 0, 0.5);
                filter: brightness(2) saturate(2);
            }
            30% { transform: scale(1.25) translateX(6px) translateY(4px) perspective(500px) translateZ(80px); }
            35% { transform: scale(1.22) translateX(-8px) translateY(-2px) perspective(500px) translateZ(100px); }
            40% { 
                transform: scale(1.3) translateX(8px) perspective(500px) translateZ(120px);
                box-shadow: 
                    0 0 80px #00ff44,
                    0 0 160px #00ff00,
                    0 0 240px rgba(0, 255, 100, 1),
                    0 0 320px rgba(0, 255, 0, 0.9),
                    0 30px 80px rgba(0, 0, 0, 0.6);
                filter: brightness(2.5) saturate(2.5);
            }
            50% { 
                transform: scale(1.35) translateY(-5px) perspective(500px) translateZ(150px);
                box-shadow: 
                    0 0 100px #ffffff,
                    0 0 200px #00ff00,
                    0 0 300px rgba(0, 255, 100, 1),
                    0 0 400px rgba(0, 255, 0, 0.8),
                    0 40px 100px rgba(0, 0, 0, 0.7);
                filter: brightness(3) saturate(3) contrast(1.2);
            }
            60% { transform: scale(1.25) translateX(-4px) perspective(500px) translateZ(100px); }
            70% { transform: scale(1.15) translateX(4px) perspective(500px) translateZ(60px); }
            80% { transform: scale(1.08) translateX(-2px) perspective(500px) translateZ(30px); }
            90% { transform: scale(1.03) translateX(2px); }
            100% { 
                transform: scale(1) translateZ(0);
                box-shadow: 0 0 20px var(--country-glow);
                filter: brightness(1);
            }
        }

        /* Card mega-boost effect - whole card pops */
        .country-card.mega-boost {
            z-index: 100;
        }

        .country-card.mega-boost .progress-container {
            animation: containerMegaBoost 1s ease;
        }

        @keyframes containerMegaBoost {
            0%, 100% { 
                box-shadow: var(--default-shadow);
                transform: scale(1);
            }
            30% {
                box-shadow: 
                    0 0 50px #00ff00, 
                    0 0 100px rgba(0, 255, 0, 0.7),
                    0 10px 40px rgba(0, 0, 0, 0.5);
                transform: scale(1.05) translateY(-5px);
            }
            50% { 
                box-shadow: 
                    0 0 80px #00ff00, 
                    0 0 150px rgba(0, 255, 0, 0.9),
                    0 20px 60px rgba(0, 0, 0, 0.6);
                transform: scale(1.08) translateY(-10px);
            }
            70% {
                transform: scale(1.03) translateY(-3px);
            }
        }

        .country-card.mega-boost .country-image {
            animation: imageMegaBoost 1s ease;
        }

        @keyframes imageMegaBoost {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            20% { transform: scale(1.3) rotate(-15deg); filter: brightness(1.5); }
            40% { transform: scale(1.5) rotate(15deg); filter: brightness(2); }
            50% { transform: scale(1.6) rotate(-10deg); filter: brightness(2.5) drop-shadow(0 0 20px #00ff00); }
            60% { transform: scale(1.4) rotate(10deg); filter: brightness(2); }
            80% { transform: scale(1.2) rotate(-5deg); filter: brightness(1.3); }
        }

        /* Screen flash for mega boost */
        .mega-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0,255,0,0.4) 0%, transparent 70%);
            pointer-events: none;
            z-index: 900;
            opacity: 0;
        }

        .mega-flash.active {
            animation: megaFlash 0.5s ease;
        }

        @keyframes megaFlash {
            0% { opacity: 0; }
            30% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Country Image on Bar */
        .country-image {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: -3px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 10px var(--country-glow), 0 3px 8px rgba(0,0,0,0.4);
            flex-shrink: 0;
            z-index: 5;
            animation: imagePulse 2s ease-in-out infinite;
            background: #1a1a2e;
        }

        @keyframes imagePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .country-card:hover .country-image {
            animation: imageHover 0.3s ease forwards;
        }

        @keyframes imageHover {
            to { transform: scale(1.15); }
        }

        /* Percentage Text - Inside Bar Left */
        .progress-text {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
            z-index: 2;
        }

        /* ==================== LEADERBOARD - RIGHT SIDE ==================== */
        .leaderboard {
            width: 35%;
            min-width: 0;
            max-width: 320px;
            background: linear-gradient(180deg, rgba(20, 20, 35, 0.98) 0%, rgba(10, 10, 20, 0.98) 100%);
            border-left: 3px solid #00ffff;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 255, 255, 0.15);
            overflow: hidden;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
        }

        .leaderboard h2 {
            color: #00ffff;
            font-size: 16px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .leaderboard-subtitle {
            color: #888;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .ranking-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            margin-bottom: 3px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ranking-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--rank-color);
            border-radius: 15px 0 0 15px;
        }

        .ranking-item:hover {
            background: rgba(0, 255, 255, 0.08);
            transform: translateX(-3px);
        }

        .rank-badge {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 900;
            font-size: 10px;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .rank-2 { background: linear-gradient(135deg, #e0e0e0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-other { background: rgba(0, 255, 255, 0.15); color: #00ffff; }

        /* Circular Image in Leaderboard */
        .ranking-image {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            border: 2px solid var(--rank-color, #00ffff);
            box-shadow: 0 0 8px var(--rank-glow, rgba(0, 255, 255, 0.3));
            flex-shrink: 0;
            background: #1a1a2e;
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-name {
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-percent {
            font-size: 8px;
            color: #888;
            margin-top: 1px;
        }

        .ranking-wins {
            font-size: 20px;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            margin-left: 10px;
        }

        .ranking-wins-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Stats Panel */
        .stats-panel {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 2px solid rgba(0, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 5px;
            font-size: 11px;
            color: #888;
        }

        .stat-value {
            color: #00ffff;
            font-weight: bold;
            font-size: 12px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            margin-top: 5px;
            border-radius: 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .connected .status-dot { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .disconnected .status-dot { background: #ff0000; animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }

        /* Hidden elements */
        .country-header,
        .gift-hints,
        .country-info,
        .country-flag {
            display: none;
        }

        /* Leaderboard Sidebar */
        .leaderboard {
            width: 35%;
            min-width: 0;
            background: linear-gradient(180deg, #12121a 0%, #0a0a0f 100%);
            border-left: 2px solid #00ffff;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 30px rgba(0, 255, 255, 0.1);
            overflow: hidden;
        }

        .leaderboard h2 {
            text-align: center;
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .leaderboard-subtitle {
            text-align: center;
            color: #666;
            font-size: 10px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .ranking-list {
            flex: 1;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            margin-bottom: 3px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        .rank-badge {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 6px;
            font-size: 10px;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-other { background: rgba(0, 255, 255, 0.2); color: #00ffff; }

        .ranking-flag {
            font-size: 16px;
            margin-right: 6px;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-size: 10px;
            font-weight: 600;
            color: #fff;
        }

        .ranking-percent {
            font-size: 8px;
            color: #888;
        }

        .ranking-wins {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
        }

        .stats-panel {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 10px;
            color: #888;
        }

        .stat-value {
            color: #00ffff;
            font-weight: bold;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            margin-top: 4px;
            border-radius: 8px;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .connected .status-dot { background: #00ff00; }
        .disconnected .status-dot { background: #ff0000; animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Victory Overlay */
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.98) 100%);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }

        .victory-overlay.active {
            display: flex;
            animation: victoryFadeIn 0.5s ease;
        }

        @keyframes victoryFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .victory-image {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 25px;
            border: 6px solid #ffd700;
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.8),
                0 0 80px rgba(255, 215, 0, 0.5),
                0 0 120px rgba(255, 215, 0, 0.3);
            animation: victoryImageBounce 0.5s ease infinite alternate;
        }

        @keyframes victoryImageBounce {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(5deg); }
        }

        .victory-title {
            font-size: 56px;
            font-weight: 900;
            color: #ffd700;
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4);
            margin-bottom: 10px;
            animation: victoryTitleGlow 0.5s ease infinite alternate;
        }

        @keyframes victoryTitleGlow {
            from { 
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 215, 0, 0.8), 0 0 120px rgba(255, 215, 0, 0.6);
                transform: scale(1.02);
            }
        }

        .victory-country {
            font-size: 48px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: victoryCountryPulse 1s ease infinite;
        }

        @keyframes victoryCountryPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .victory-contributor {
            font-size: 24px;
            color: #00ffff;
            margin-bottom: 30px;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .victory-timer {
            font-size: 28px;
            color: #888;
            animation: timerPulse 1s ease infinite;
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fireworks */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* Activity Feed */
        .activity-feed {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 300px;
            max-height: 150px;
            overflow: hidden;
            z-index: 100;
        }

        .feed-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 10px;
            font-size: 12px;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 3px solid;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .feed-item.boost { border-color: #00ff88; }
        .feed-item.sabotage { border-color: #ff4444; }

        .feed-emoji { font-size: 16px; }
        .feed-user { color: #00ffff; font-weight: bold; }
        .feed-action { color: #888; }
        .feed-target { font-weight: 600; }
        .feed-item.boost .feed-target { color: #00ff88; }
        .feed-item.sabotage .feed-target { color: #ff4444; }

        /* Gift Notification */
        .gift-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            z-index: 500;
            animation: popIn 1.2s ease forwards;
            pointer-events: none;
            text-align: center;
        }

        .gift-notification .emoji { font-size: 70px; display: block; }
        .gift-notification.boost { color: #00ff88; text-shadow: 0 0 30px rgba(0, 255, 136, 0.8); }
        .gift-notification.comment { color: #6366f1; text-shadow: 0 0 30px rgba(99, 102, 241, 0.8); }
        .gift-notification.mega { 
            color: #ffcc00; 
            text-shadow: 0 0 40px rgba(255, 200, 0, 1), 0 0 80px rgba(255, 102, 0, 0.8);
            animation: megaNotification 1.5s ease forwards;
        }

        @keyframes megaNotification {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.4) rotate(5deg); }
            40% { transform: translate(-50%, -50%) scale(1.2) rotate(-3deg); }
            60% { transform: translate(-50%, -50%) scale(1.3) rotate(2deg); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9) translateY(-50px); }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) translateY(-40px); }
        }

        /* Touch Control Panel */
        .control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 20, 0.98);
            border-top: 3px solid #ff6600;
            z-index: 1001;
            transition: transform 0.3s ease;
            max-height: 50vh;
            display: none;
        }
        .control-panel.visible {
            display: block;
        }

        .control-panel.minimized {
            transform: translateY(calc(100% - 50px));
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(90deg, #ff660033, transparent);
            min-height: 50px;
            cursor: pointer;
        }

        .panel-header span {
            font-weight: bold;
            color: #ff6600;
            font-size: 16px;
        }

        .toggle-btn {
            background: #ff6600;
            border: none;
            color: #000;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .panel-content {
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            min-width: 90px;
        }

        .action-btn small { font-size: 11px; opacity: 0.9; display: block; margin-top: 2px; }
        .comment-btn { background: linear-gradient(135deg, #6366f1, #4f46e5); box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); }
        .boost-btn { background: linear-gradient(135deg, #00c853, #009624); box-shadow: 0 4px 20px rgba(0, 200, 83, 0.4); }
        .mega-btn { 
            background: linear-gradient(135deg, #ff6600, #ff9500, #ffcc00); 
            box-shadow: 0 4px 20px rgba(255, 102, 0, 0.5);
            animation: megaBtnPulse 2s ease infinite;
        }
        @keyframes megaBtnPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(255, 102, 0, 0.5); }
            50% { box-shadow: 0 4px 35px rgba(255, 200, 0, 0.7); }
        }
        .action-btn:active { transform: scale(0.95); }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .quick-btn {
            padding: 15px 20px;
            border: 2px solid #444;
            border-radius: 12px;
            background: #2a2a3e;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        .quick-btn:active { background: #4a4a5e; border-color: #ff6600; }

        /* Responsive - ALWAYS landscape side-by-side */
        @media (max-width: 1000px) {
            .game-area { max-width: 60%; padding: 5px 8px; }
            .leaderboard { width: 40%; min-width: 0; max-width: none; padding: 5px 8px; }
            .ranking-wins { font-size: 16px; }
            .ranking-image { width: 24px; height: 24px; }
            .game-title h1 { font-size: 16px; letter-spacing: 2px; }
            .game-subtitle { font-size: 7px; }
            .leaderboard h2 { font-size: 14px; }
        }

        @media (max-width: 700px) {
            .game-area { max-width: 58%; padding: 4px 6px; }
            .leaderboard { width: 42%; min-width: 0; padding: 4px 6px; }
            .progress-container { height: 24px; }
            .country-image { width: 24px; height: 24px; }
            .bar-country-name { font-size: 7px; right: 20px; }
            .bar-boost-emoji { font-size: 10px; right: 5px; }
            .progress-text { font-size: 9px; left: 8px; }
            .game-title h1 { font-size: 14px; }
            .ranking-item { padding: 3px 5px; margin-bottom: 2px; }
            .rank-badge { width: 18px; height: 18px; font-size: 8px; margin-right: 4px; }
            .ranking-image { width: 20px; height: 20px; margin-right: 5px; }
            .ranking-name { font-size: 9px; }
            .ranking-percent { font-size: 7px; }
            .ranking-wins { font-size: 14px; }
            .leaderboard h2 { font-size: 12px; letter-spacing: 1px; }
            .leaderboard-subtitle { font-size: 7px; }
            .leaderboard-header { margin-bottom: 4px; padding-bottom: 4px; }
        }

        @media (max-width: 500px) {
            .game-area { max-width: 55%; padding: 3px 4px; }
            .leaderboard { width: 45%; min-width: 0; padding: 3px 4px; }
            .progress-container { height: 20px; }
            .country-image { width: 20px; height: 20px; border-width: 1px; }
            .bar-country-name { font-size: 6px; right: 16px; }
            .bar-boost-emoji { font-size: 8px; right: 3px; }
            .progress-text { font-size: 8px; left: 5px; }
            .cards-grid { gap: 1px; padding: 1px 3px; }
            .game-title h1 { font-size: 11px; letter-spacing: 1px; }
            .game-subtitle { font-size: 6px; }
            .ranking-item { padding: 2px 4px; margin-bottom: 1px; border-radius: 6px; }
            .rank-badge { width: 14px; height: 14px; font-size: 7px; margin-right: 3px; }
            .ranking-image { width: 16px; height: 16px; margin-right: 3px; border-width: 1px; }
            .ranking-name { font-size: 8px; }
            .ranking-wins { font-size: 12px; }
            .leaderboard h2 { font-size: 10px; }
            .stats-panel { margin-top: 2px; padding-top: 2px; }
            .stat-item { font-size: 8px; padding: 1px 0; }
            .connection-status { padding: 2px; font-size: 7px; margin-top: 2px; }
            .status-dot { width: 5px; height: 5px; margin-right: 4px; }
        }

        /* Hide control panel on small heights */
        @media (max-height: 700px) {
            .control-panel { display: none; }
            .activity-feed { bottom: 10px; left: 10px; width: 250px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(0, 255, 255, 0.3); border-radius: 3px; }

        /* Cheer Notification */
        .cheer-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 165, 0, 0.95));
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 600;
            animation: cheerSlide 4s ease forwards;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
            max-width: 90vw;
        }

        .cheer-flag {
            font-size: 40px;
            animation: cheerBounce 0.5s ease infinite alternate;
        }

        .cheer-text {
            font-size: 18px;
            font-weight: bold;
            color: #000;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
        }

        @keyframes cheerSlide {
            0% { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        @keyframes cheerBounce {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(5deg); }
        }

        /* Audio Toggle Button */
        .audio-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #333, #222);
            border: 2px solid #00ffff;
            color: #00ffff;
            font-size: 24px;
            cursor: pointer;
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.3);
            transition: all 0.2s;
        }

        .audio-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 30px rgba(0, 255, 255, 0.5);
        }

        .audio-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 900px) {
            .audio-toggle {
                top: 10px;
                right: 10px;
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            .cheer-notification {
                top: 60px;
                padding: 10px 20px;
            }
            .cheer-flag { font-size: 30px; }
            .cheer-text { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Game Area -->
        <div class="game-area">
            <div class="game-title">
                <h1>‚öîÔ∏è BATALLA LATINA ‚öîÔ∏è</h1>
                <div class="game-subtitle">Comenta el nombre de tu pa√≠s ‚Ä¢ Env√≠a regalos ‚Ä¢ ¬°500 para ganar!</div>
            </div>

            <!-- 3x3 Grid of Country Cards -->
            <div class="cards-grid" id="cards-grid"></div>
        </div>

        <!-- Leaderboard Sidebar - Right Side -->
        <div class="leaderboard">
            <div class="leaderboard-header">
                <h2>üèÜ VICTORIAS</h2>
                <div class="leaderboard-subtitle">Ranking del D√≠a</div>
            </div>
            <div class="ranking-list" id="ranking-list"></div>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <span>Ronda</span>
                    <span class="stat-value" id="round-number">1</span>
                </div>
                <div class="stat-item">
                    <span>Acciones</span>
                    <span class="stat-value" id="total-actions">0</span>
                </div>
                <div class="stat-item">
                    <span>Decay</span>
                    <span class="stat-value" id="decay-timer">15s</span>
                </div>
            </div>
            
            <div class="connection-status disconnected" id="connection-status">
                <span class="status-dot"></span>
                <span id="status-text">Desconectado</span>
            </div>
        </div>
    </div>

    <!-- Audio Toggle Button -->
    <button class="audio-toggle" id="audio-toggle" onclick="toggleAudio()" title="Mute cheers">üîä</button>

    <!-- Activity Feed -->
    <div class="activity-feed" id="activity-feed"></div>

    <!-- Victory Overlay -->
    <div class="victory-overlay" id="victory-overlay">
        <img class="victory-image" id="victory-image" src="" alt="Winner">
        <div class="victory-title">üéâ ¬°GANADOR! üéâ</div>
        <div class="victory-country" id="victory-country">Country</div>
        <div class="victory-contributor" id="victory-contributor">MVP: User</div>
        <div class="victory-timer" id="victory-timer">Nueva ronda en 10s</div>
    </div>

    <!-- Fireworks -->
    <canvas id="fireworks-canvas"></canvas>

    <!-- Mega Boost Flash -->
    <div class="mega-flash" id="mega-flash"></div>

    <!-- Touch Control Panel -->
    <div class="control-panel" id="control-panel">
        <div class="panel-header" onclick="togglePanel()">
            <span>üéÆ TAP COUNTRY ABOVE ‚Ä¢ THEN ACTION BELOW</span>
            <button class="toggle-btn" id="toggle-btn">‚àí</button>
        </div>
        <div class="panel-content" id="panel-content">
            <div class="action-buttons">
                <button class="action-btn comment-btn" onclick="testAction('comment')">
                    üí¨ Comentar<small>+1 move</small>
                </button>
                <button class="action-btn boost-btn" onclick="testAction('small')">
                    üéÅ Regalo<small>+2 moves</small>
                </button>
                <button class="action-btn mega-btn" onclick="testAction('mega')">
                    üöÄ MEGA BOOST<small>+125 moves</small>
                </button>
            </div>
            <div class="quick-actions">
                <button class="quick-btn" onclick="testCheer()">üì¢ Next</button>
                <button class="quick-btn" onclick="testAllCheers()">üîä Test All</button>
                <button class="quick-btn" onclick="startDemoMode()">‚ñ∂Ô∏è Demo</button>
                <button class="quick-btn" onclick="resetRound()">üîÑ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            wsUrl: 'ws://localhost:21213',
            decayInterval: 15000,
            decayAmount: 1.5,
            victoryDuration: 45000,
            maxMoves: 500, // Total moves to win
            commentMoves: 1, // Comment = 1 move
            smallGiftMoves: 2, // 1-coin gift = 2 moves
            boostMoves: 125, // 100-coin gift = 125 moves
            sabotageAmount: 25 // Still percentage based
        };

        // ==================== COUNTRY DATA ====================
        const countries = {
            colombia: {
                name: 'Colombia',
                flag: 'üá®üá¥',
                abbr: ['co', 'col'],
                color: '#fcd116',
                glow: 'rgba(252, 209, 22, 0.5)',
                image: 'https://flagcdn.com/w160/co.png',
                moves: 0,
                contributors: {},
                smallGifts: ['rose', '5655'], // 1-coin
                boostGifts: ['little crown', 'crown', '5830'], // 99-coin
                smallEmoji: 'üåπ',
                boostEmoji: 'üëë'
            },
            venezuela: {
                name: 'Venezuela',
                flag: 'üáªüá™',
                abbr: ['ve', 'ven'],
                color: '#cf142b',
                glow: 'rgba(207, 20, 43, 0.5)',
                image: 'https://flagcdn.com/w160/ve.png',
                moves: 0,
                contributors: {},
                smallGifts: ['tiktok', 'tiktok logo', '5906'], // 1-coin
                boostGifts: ['cap', '5829'], // 99-coin
                smallEmoji: 'üéµ',
                boostEmoji: 'üß¢'
            },
            ecuador: {
                name: 'Ecuador',
                flag: 'üá™üá®',
                abbr: ['ec', 'ecu'],
                color: '#ffd100',
                glow: 'rgba(255, 209, 0, 0.5)',
                image: 'https://flagcdn.com/w160/ec.png',
                moves: 0,
                contributors: {},
                smallGifts: ['ice cream', 'ice cream cone', 'icecream', '5826'], // 1-coin
                boostGifts: ['paper crane', 'crane', '5900'], // 99-coin
                smallEmoji: 'üç¶',
                boostEmoji: 'ü¶¢'
            },
            mexico: {
                name: 'M√©xico',
                flag: 'üá≤üáΩ',
                abbr: ['mx', 'mex'],
                color: '#006847',
                glow: 'rgba(0, 104, 71, 0.5)',
                image: 'https://flagcdn.com/w160/mx.png',
                moves: 0,
                contributors: {},
                smallGifts: ['chilli', 'chilli pepper', 'pepper', 'chile', '5765'], // 1-coin
                boostGifts: ['singing magic', 'singing', 'magic', '5878'], // 100-coin
                smallEmoji: 'üå∂Ô∏è',
                boostEmoji: 'üé§'
            },
            elsalvador: {
                name: 'El Salvador',
                flag: 'üá∏üáª',
                abbr: ['sv', 'sal'],
                color: '#0047ab',
                glow: 'rgba(0, 71, 171, 0.5)',
                image: 'https://flagcdn.com/w160/sv.png',
                moves: 0,
                contributors: {},
                smallGifts: ['thumbs up', 'thumbsup', 'thumb', '5659'], // 1-coin
                boostGifts: ['confetti', '5839'], // 100-coin
                smallEmoji: 'üëç',
                boostEmoji: 'üéâ'
            },
            nicaragua: {
                name: 'Nicaragua',
                flag: 'üá≥üáÆ',
                abbr: ['ni', 'nic'],
                color: '#17c3b2',
                glow: 'rgba(23, 195, 178, 0.5)',
                image: 'https://flagcdn.com/w160/ni.png',
                moves: 0,
                contributors: {},
                smallGifts: ['gg', '5905'], // 1-coin
                boostGifts: ['super gg', 'supergg', '5879'], // 100-coin
                smallEmoji: 'üéÆ',
                boostEmoji: 'üèÜ'
            },
            guatemala: {
                name: 'Guatemala',
                flag: 'üá¨üáπ',
                abbr: ['gt', 'gua'],
                color: '#4997d0',
                glow: 'rgba(73, 151, 208, 0.5)',
                image: 'https://flagcdn.com/w160/gt.png',
                moves: 0,
                contributors: {},
                smallGifts: ['club cheers', 'cheers', 'club', '5827'], // 1-coin
                boostGifts: ['hand hearts', 'handhearts', 'hand heart', '5880'], // 100-coin
                smallEmoji: 'ü•Ç',
                boostEmoji: 'ü´∂'
            },
            peru: {
                name: 'Per√∫',
                flag: 'üáµüá™',
                abbr: ['pe', 'per'],
                color: '#d91023',
                glow: 'rgba(217, 16, 35, 0.5)',
                image: 'https://flagcdn.com/w160/pe.png',
                moves: 0,
                contributors: {},
                smallGifts: ['graduation bouquet', 'graduation', 'bouquet', '5904'], // 1-coin
                boostGifts: ['game controller', 'controller', 'gamecontroller', '5881'], // 100-coin
                smallEmoji: 'üíê',
                boostEmoji: 'üéÆ'
            },
            puertorico: {
                name: 'Puerto Rico',
                flag: 'üáµüá∑',
                abbr: ['pr', 'pur'],
                color: '#eb4034',
                glow: 'rgba(235, 64, 52, 0.5)',
                image: 'https://flagcdn.com/w160/pr.png',
                moves: 0,
                contributors: {},
                smallGifts: ['glow stick', 'glowstick', 'glow', '5820'], // 1-coin
                boostGifts: ['marvelous confetti', 'marvelous', '5882'], // 100-coin
                smallEmoji: '‚ú®',
                boostEmoji: 'üéä'
            },
            dominicana: {
                name: 'Rep. Dominicana',
                flag: 'üá©üá¥',
                abbr: ['do', 'dom', 'rd'],
                color: '#002d62',
                glow: 'rgba(0, 45, 98, 0.5)',
                image: 'https://flagcdn.com/w160/do.png',
                moves: 0,
                contributors: {},
                smallGifts: ['cake slice', 'cake', 'slice', '5659'], // 1-coin
                boostGifts: ['bowknot', 'bow', '5883'], // 100-coin
                smallEmoji: 'üç∞',
                boostEmoji: 'üéÄ'
            },
            chile: {
                name: 'Chile',
                flag: 'üá®üá±',
                abbr: ['cl', 'chi'],
                color: '#d52b1e',
                glow: 'rgba(213, 43, 30, 0.5)',
                image: 'https://flagcdn.com/w160/cl.png',
                moves: 0,
                contributors: {},
                smallGifts: ['pumpkin', '5660'], // 1-coin
                boostGifts: ['mishka bear', 'mishka', 'bear', '5879'], // 100-coin
                smallEmoji: 'üéÉ',
                boostEmoji: 'üß∏'
            },
            trump: {
                name: 'United States',
                flag: 'üá∫üá∏',
                abbr: ['us', 'usa', 'trump'],
                color: '#ff6600',
                glow: 'rgba(255, 102, 0, 0.5)',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Donald_Trump_official_portrait.jpg/220px-Donald_Trump_official_portrait.jpg',
                moves: 0,
                contributors: {},
                smallGifts: ['youre awesome', 'you\'re awesome', 'awesome', '5661'], // 1-coin
                boostGifts: ['hat and mustache', 'hat mustache', 'mustache', '5884'], // 99-coin
                smallEmoji: 'üåü',
                boostEmoji: 'üé©'
            }
        };

        // ==================== GAME STATE ====================
        let gameState = {
            roundNumber: 1,
            totalActions: 0,
            isVictoryMode: false,
            dailyWins: loadDailyWins(),
            decayTimer: 15,
            selectedCountry: null,
            ws: null,
            connected: false,
            demoInterval: null,
            currentLeader: null,
            cheerInterval: null,
            lastCheerTime: 0
        };

        // ==================== SPANISH CHEERS ====================
        const countryChants = {
            colombia: [
                "¬°Vamos Colombia, t√∫ puedes ganar!",
                "¬°Colombia, Colombia, ole ole ol√©!",
                "¬°S√≠ se puede, s√≠ se puede, Colombia!",
                "¬°Este es el pa√≠s de Colombia!"
            ],
            venezuela: [
                "¬°Vamos la vinotinto, vamos a ganar!",
                "¬°Venezuela, Venezuela, esta barra te quiere!",
                "¬°Arriba Venezuela, vamos a ganar!",
                "¬°Vinotinto te llevo en el coraz√≥n!"
            ],
            ecuador: [
                "¬°S√≠ se puede Ecuador, s√≠ se puede!",
                "¬°Ecuador, Ecuador, ole ole ol√©!",
                "¬°Vamos tricolor, vamos a ganar!",
                "¬°Ecuador mi pa√≠s, te llevo en mi coraz√≥n!"
            ],
            mexico: [
                "¬°Vamos vamos M√©xico, a la delantera!",
                "¬°Cielito lindo, M√©xico, M√©xico!",
                "¬°S√≠ se puede, s√≠ se puede, M√©xico!",
                "¬°M√©xico, M√©xico, ra ra ra!"
            ],
            elsalvador: [
                "¬°Vamos vamos la selecta, vamos a ganar!",
                "¬°El Salvador, El Salvador, ole ole ol√©!",
                "¬°Pulgarcito de Am√©rica, adelante!",
                "¬°Arriba la selecta, vamos a ganar!"
            ],
            nicaragua: [
                "¬°Arriba los pinoleros, vamos a ganar!",
                "¬°Nicaragua, Nicaragua, s√≠ se puede!",
                "¬°Vamos azul y blanco, adelante!",
                "¬°Nicaragua campe√≥n, s√≠ se puede!"
            ],
            guatemala: [
                "¬°Vamos la azul y blanco, vamos a ganar!",
                "¬°Guatemala, Guatemala, ole ole ol√©!",
                "¬°Arriba los chapines, s√≠ se puede!",
                "¬°Guate, Guate, vamos Guate!"
            ],
            peru: [
                "¬°Arriba Per√∫, arriba arriba!",
                "¬°Per√∫, Per√∫, Per√∫, contigo Per√∫!",
                "¬°Vamos blanquirroja, vamos a ganar!",
                "¬°Como no te voy a querer, Per√∫!"
            ],
            puertorico: [
                "¬°Puerto Rico, lo hace mejor!",
                "¬°Wepa wepa, Puerto Rico!",
                "¬°Boricua, boricua, dale dale!",
                "¬°Puerto Rico me encanta!"
            ],
            dominicana: [
                "¬°Quisqueya la bella, arriba!",
                "¬°Dominicana, Dominicana, s√≠ se puede!",
                "¬°Aqu√≠ lleg√≥ la quisqueya!",
                "¬°Rep√∫blica Dominicana, a ganar!"
            ],
            chile: [
                "¬°Chi chi chi, le le le, viva Chile!",
                "¬°Vamos chilenos, vamos a ganar!",
                "¬°Chile, Chile, lindo Chile!",
                "¬°Ceache√≠, ceache√≠, viva Chile!"
            ],
            trump: [
                "Chi-na! Chi-na! Chi-na!",
                "Money money money! Trump is winning!",
                "Make America Great Again!",
                "We're winning, we're winning big league!",
                "Tremendous! Absolutely tremendous!"
            ]
        };

        let speechEnabled = true;
        let speechReady = false;
        let voices = [];

        // Initialize speech synthesis
        function initSpeech() {
            if (!window.speechSynthesis) {
                console.log('Speech synthesis not supported');
                return;
            }

            // Load voices
            voices = window.speechSynthesis.getVoices();
            
            // Chrome loads voices async
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    voices = window.speechSynthesis.getVoices();
                    console.log('Voices loaded:', voices.length);
                    speechReady = true;
                };
            } else {
                speechReady = true;
            }

            // Unlock audio on first user interaction
            const unlockAudio = () => {
                if (window.speechSynthesis) {
                    const unlock = new SpeechSynthesisUtterance('');
                    unlock.volume = 0;
                    window.speechSynthesis.speak(unlock);
                    console.log('Speech unlocked');
                }
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
            };

            document.addEventListener('click', unlockAudio);
            document.addEventListener('touchstart', unlockAudio);
        }

        function speakCheer(countryId, force = false) {
            if (!speechEnabled || gameState.isVictoryMode) return;
            
            const now = Date.now();
            // Don't cheer more often than every 8 seconds (unless forced)
            if (!force && now - gameState.lastCheerTime < 8000) return;
            gameState.lastCheerTime = now;

            const chants = countryChants[countryId];
            if (!chants) return;

            const chant = chants[Math.floor(Math.random() * chants.length)];
            const country = countries[countryId];

            // Show visual notification regardless of audio
            showCheerNotification(country.flag, chant);

            // Try speech synthesis
            if (window.speechSynthesis) {
                try {
                    window.speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(chant);
                    
                    // Use English for Trump, Spanish for others
                    if (countryId === 'trump') {
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        utterance.pitch = 0.8; // Lower pitch for Trump impression
                    } else {
                        utterance.lang = 'es-ES';
                        utterance.rate = 1.0;
                        utterance.pitch = 1.1;
                    }
                    utterance.volume = 1.0;

                    // Find best voice
                    const currentVoices = window.speechSynthesis.getVoices();
                    let voice;
                    if (countryId === 'trump') {
                        voice = currentVoices.find(v => v.lang.startsWith('en-US')) || 
                                currentVoices.find(v => v.lang.startsWith('en'));
                    } else {
                        voice = currentVoices.find(v => 
                            v.lang === 'es-MX' || v.lang === 'es-ES' || v.lang.startsWith('es')
                        );
                    }
                    
                    if (voice) {
                        utterance.voice = voice;
                        console.log('Using voice:', voice.name);
                    }

                    utterance.onerror = (e) => {
                        console.log('Speech error:', e.error);
                        playCheerTone(countryId);
                    };

                    window.speechSynthesis.speak(utterance);
                    console.log('Speaking:', chant);

                } catch (e) {
                    console.log('Speech failed:', e);
                    playCheerTone(countryId);
                }
            } else {
                playCheerTone(countryId);
            }
        }

        // Fallback: Play musical tones for the country
        function playCheerTone(countryId) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Different melody patterns for each country
                const melodies = {
                    colombia: [392, 440, 494, 523, 494, 440],
                    venezuela: [349, 392, 440, 494, 440, 392],
                    ecuador: [440, 494, 523, 587, 523, 494],
                    mexico: [523, 587, 659, 587, 523, 494],
                    elsalvador: [392, 440, 523, 440, 392, 349],
                    nicaragua: [440, 523, 440, 523, 587, 494],
                    guatemala: [349, 440, 523, 440, 349, 392],
                    peru: [494, 523, 587, 659, 587, 523],
                    puertorico: [523, 587, 659, 698, 659, 587],
                    dominicana: [392, 494, 587, 494, 392, 440],
                    chile: [523, 523, 587, 587, 659, 523],
                    trump: [659, 659, 587, 523, 587, 659, 698, 659] // More dramatic for Trump
                };

                const notes = melodies[countryId] || melodies.mexico;
                const duration = 0.15;

                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    
                    const startTime = audioCtx.currentTime + (i * duration);
                    gain.gain.setValueAtTime(0.3, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                    
                    osc.start(startTime);
                    osc.stop(startTime + duration);
                });

            } catch (e) {
                console.log('Audio fallback failed:', e);
            }
        }

        function showCheerNotification(flag, text) {
            const notif = document.createElement('div');
            notif.className = 'cheer-notification';
            notif.innerHTML = `<span class="cheer-flag">${flag}</span><span class="cheer-text">${text}</span>`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        function checkLeaderAndCheer() {
            if (gameState.isVictoryMode) return;

            let leader = null;
            let maxMoves = 0;

            Object.entries(countries).forEach(([id, country]) => {
                if (country.moves > maxMoves && country.moves > 10) {
                    maxMoves = country.moves;
                    leader = id;
                }
            });

            // If leader changed, announce it
            if (leader && leader !== gameState.currentLeader) {
                gameState.currentLeader = leader;
                speakCheer(leader);
            }
        }

        // Periodic cheer for current leader (every 15-20 seconds)
        function startCheerSystem() {
            initSpeech();

            gameState.cheerInterval = setInterval(() => {
                if (gameState.currentLeader && !gameState.isVictoryMode) {
                    speakCheer(gameState.currentLeader);
                }
            }, 15000 + Math.random() * 5000);
        }

        function toggleAudio() {
            speechEnabled = !speechEnabled;
            const btn = document.getElementById('audio-toggle');
            btn.textContent = speechEnabled ? 'üîä' : 'üîá';
            btn.title = speechEnabled ? 'Mute cheers' : 'Enable cheers';
            
            if (!speechEnabled && window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            showGiftNotification(speechEnabled ? 'üîä' : 'üîá', speechEnabled ? 'Audio ON' : 'Audio OFF', 'boost');
        }

        // Test button to manually trigger cheers - cycles through all countries
        let testCheerIndex = 0;
        const countryIds = ['colombia', 'venezuela', 'ecuador', 'mexico', 'elsalvador', 'nicaragua', 'guatemala', 'peru', 'puertorico', 'dominicana', 'chile', 'trump'];

        function testCheer() {
            const id = countryIds[testCheerIndex];
            testCheerIndex = (testCheerIndex + 1) % countryIds.length;
            
            // Force the cheer even if one just played
            gameState.lastCheerTime = 0;
            speakCheer(id, true);
        }

        // Test all countries in sequence
        let testAllInterval = null;
        
        function testAllCheers() {
            if (testAllInterval) {
                clearInterval(testAllInterval);
                testAllInterval = null;
                showGiftNotification('‚èπÔ∏è', 'Stopped', 'sabotage');
                return;
            }
            
            testCheerIndex = 0;
            showGiftNotification('üîä', 'Testing All!', 'boost');
            
            // Play first one immediately
            testCheer();
            
            // Then cycle through rest every 5 seconds
            testAllInterval = setInterval(() => {
                if (testCheerIndex === 0) {
                    // We've gone through all, stop
                    clearInterval(testAllInterval);
                    testAllInterval = null;
                    showGiftNotification('‚úÖ', 'Test Done!', 'boost');
                    return;
                }
                testCheer();
            }, 5000);
        }

        // ==================== STORAGE ====================
        function loadDailyWins() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('scribbleWar_dailyWins');
            if (stored) {
                const data = JSON.parse(stored);
                if (data.date === today) return data.wins;
            }
            return {};
        }

        function saveDailyWins() {
            localStorage.setItem('scribbleWar_dailyWins', JSON.stringify({
                date: new Date().toDateString(),
                wins: gameState.dailyWins
            }));
        }

        // ==================== UI GENERATION ====================
        function createCountryCards() {
            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';

            Object.entries(countries).forEach(([id, country]) => {
                const card = document.createElement('div');
                card.className = 'country-card';
                card.id = `card-${id}`;
                card.style.setProperty('--country-color', country.color);
                card.style.setProperty('--country-glow', country.glow);
                card.style.setProperty('--country-color-light', country.color + 'cc');
                
                card.innerHTML = `
                    <div class="country-label">
                        <span class="country-name">${country.name}</span>
                        <span class="boost-emoji">${country.boostEmoji}</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" id="fill-${id}">
                            <img class="country-image" src="${country.image}" alt="${country.name}" onerror="this.src='https://flagcdn.com/w160/un.png'">
                        </div>
                        <span class="progress-text" id="text-${id}">0%</span>
                        <span class="bar-country-name">${country.name}</span>
                        <span class="bar-boost-emoji">${country.boostEmoji}</span>
                    </div>
                `;

                card.onclick = () => selectCountry(id);
                card.ontouchstart = (e) => {
                    e.preventDefault();
                    selectCountry(id);
                };

                grid.appendChild(card);
            });

            selectCountry('colombia');
        }

        function selectCountry(countryId) {
            gameState.selectedCountry = countryId;

            document.querySelectorAll('.country-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.getElementById(`card-${countryId}`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            if (navigator.vibrate) navigator.vibrate(20);
        }

        // ==================== PROGRESS BAR UPDATE ====================
        function updateProgressBar(countryId) {
            const country = countries[countryId];
            if (!country) return;

            const percent = (country.moves / CONFIG.maxMoves) * 100;

            const fillEl = document.getElementById(`fill-${countryId}`);
            const textEl = document.getElementById(`text-${countryId}`);

            if (fillEl) {
                const displayWidth = Math.max(15, percent);
                fillEl.style.width = `${Math.min(100, displayWidth)}%`;
            }
            if (textEl) {
                textEl.textContent = `${country.moves}/${CONFIG.maxMoves}`;
            }

            if (country.moves >= CONFIG.maxMoves && !gameState.isVictoryMode) {
                triggerVictory(countryId);
            }
        }

        // ==================== MOVE HANDLERS ====================
        
        // Comment trigger (+1 move)
        function handleComment(countryId, username) {
            if (!countries[countryId] || gameState.isVictoryMode) return;
            
            addMoves(countryId, CONFIG.commentMoves, username);
            addFeedItem(username, 'coment√≥', countryId, 'üí¨', 'comment');
        }

        // Small gift trigger (+2 moves)
        function handleSmallGift(countryId, username, giftName) {
            if (!countries[countryId] || gameState.isVictoryMode) return;

            const country = countries[countryId];
            addMoves(countryId, CONFIG.smallGiftMoves, username);
            
            showGiftNotification(country.smallEmoji, '+2', 'boost');
            addFeedItem(username, 'regal√≥', countryId, country.smallEmoji, 'gift');
        }

        // MEGA BOOST trigger (+125 moves with EXTREME epic animation)
        function handleMegaBoost(countryId, username, giftName) {
            if (!countries[countryId] || gameState.isVictoryMode) return;

            const country = countries[countryId];
            
            // EPIC visual effects
            const card = document.getElementById(`card-${countryId}`);
            const fillEl = document.getElementById(`fill-${countryId}`);
            const flashEl = document.getElementById('mega-flash');
            
            // Screen flash
            if (flashEl) {
                flashEl.classList.add('active');
                setTimeout(() => flashEl.classList.remove('active'), 500);
            }
            
            if (card) {
                card.classList.add('mega-boost');
                setTimeout(() => card.classList.remove('mega-boost'), 1000);
            }
            
            if (fillEl) {
                fillEl.classList.add('boosting');
                setTimeout(() => fillEl.classList.remove('boosting'), 1000);
            }
            
            // Play epic sound
            playBoostSound();
            
            // Add the moves
            addMoves(countryId, CONFIG.boostMoves, username);
            
            showGiftNotification(country.boostEmoji, 'üöÄ MEGA BOOST +125!', 'mega');
            addFeedItem(username, '¬°MEGA BOOST!', countryId, country.boostEmoji, 'mega');
        }

        // Core function to add moves and update bar
        function addMoves(countryId, moveCount, username) {
            const country = countries[countryId];
            if (!country) return;

            country.moves = Math.min(CONFIG.maxMoves, country.moves + moveCount);
            
            if (username) {
                country.contributors[username] = (country.contributors[username] || 0) + moveCount;
            }

            gameState.totalActions += moveCount;
            
            // Trigger green glow
            const fillEl = document.getElementById(`fill-${countryId}`);
            if (fillEl && !fillEl.classList.contains('boosting')) {
                fillEl.classList.add('moving');
                setTimeout(() => fillEl.classList.remove('moving'), 400);
            }
            
            updateProgressBar(countryId);
            updateUI();
            checkLeaderAndCheer();
        }

        function playBoostSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Epic rising power-up sound
                const notes = [300, 400, 500, 600, 700, 800, 1000, 1200, 1500, 1800];
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = i < 5 ? 'sine' : 'triangle';
                    osc.frequency.value = freq;
                    const startTime = audioCtx.currentTime + (i * 0.06);
                    gain.gain.setValueAtTime(0.25, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.12);
                    osc.start(startTime);
                    osc.stop(startTime + 0.12);
                });
                
                // Add a final "boom" bass hit
                setTimeout(() => {
                    const bass = audioCtx.createOscillator();
                    const bassGain = audioCtx.createGain();
                    bass.connect(bassGain);
                    bassGain.connect(audioCtx.destination);
                    bass.type = 'sine';
                    bass.frequency.value = 80;
                    bassGain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    bassGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    bass.start();
                    bass.stop(audioCtx.currentTime + 0.3);
                }, 500);
            } catch (e) {}
        }

        function playAlarmSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.1);
                osc.frequency.setValueAtTime(800, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } catch (e) {}
        }

        // ==================== GIFT & COMMENT MATCHING ====================
        
        // Find country from comment text (name or abbreviation)
        function findCountryFromComment(comment) {
            const text = comment.toLowerCase().trim();
            
            for (const [countryId, country] of Object.entries(countries)) {
                // Check full name
                if (text.includes(country.name.toLowerCase())) {
                    return countryId;
                }
                // Check abbreviations
                for (const abbr of country.abbr) {
                    // Match whole word or with common patterns
                    const regex = new RegExp(`\\b${abbr}\\b|^${abbr}$|#${abbr}\\b`, 'i');
                    if (regex.test(text)) {
                        return countryId;
                    }
                }
            }
            return null;
        }

        // Find country and gift type from gift name/id
        function findCountryForGift(giftName, giftId) {
            const terms = [giftName?.toLowerCase() || '', giftId?.toString() || ''];

            for (const [countryId, country] of Object.entries(countries)) {
                // Check small gifts (1-coin = 2 moves)
                for (const term of terms) {
                    if (term && country.smallGifts.some(g => term.includes(g) || g.includes(term))) {
                        return { countryId, type: 'small' };
                    }
                }
                // Check boost gifts (100-coin = 125 moves)
                for (const term of terms) {
                    if (term && country.boostGifts.some(g => term.includes(g) || g.includes(term))) {
                        return { countryId, type: 'boost' };
                    }
                }
            }
            return null;
        }

        // ==================== VICTORY ====================
        function triggerVictory(countryId) {
            const country = countries[countryId];
            gameState.isVictoryMode = true;

            let topContributor = 'Anonymous';
            let maxContributions = 0;
            Object.entries(country.contributors).forEach(([name, count]) => {
                if (count > maxContributions) {
                    maxContributions = count;
                    topContributor = name;
                }
            });

            gameState.dailyWins[countryId] = (gameState.dailyWins[countryId] || 0) + 1;
            saveDailyWins();

            document.getElementById('victory-image').src = country.image;
            document.getElementById('victory-country').textContent = country.name;
            document.getElementById('victory-contributor').textContent = `MVP: ${topContributor}`;
            document.getElementById('victory-overlay').classList.add('active');

            startFireworks();
            
            // Epic victory cheers - play 3 times
            speakCheer(countryId, true);
            setTimeout(() => speakCheer(countryId, true), 3000);
            setTimeout(() => speakCheer(countryId, true), 6000);

            let countdown = 10;
            const timerEl = document.getElementById('victory-timer');
            const interval = setInterval(() => {
                countdown--;
                timerEl.textContent = `Nueva ronda en ${countdown}s`;
                if (countdown <= 0) {
                    clearInterval(interval);
                    resetRound();
                }
            }, 1000);
        }

        function resetRound() {
            document.getElementById('victory-overlay').classList.remove('active');
            stopFireworks();

            Object.keys(countries).forEach(id => {
                countries[id].moves = 0;
                countries[id].contributors = {};
                updateProgressBar(id);
            });

            gameState.roundNumber++;
            gameState.isVictoryMode = false;
            gameState.currentLeader = null;
            updateUI();
        }

        // ==================== FIREWORKS ====================
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const fireworksCtx = fireworksCanvas.getContext('2d');
        let fireworks = [], particles = [], fireworksRunning = false;

        function resizeFireworks() {
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeFireworks);
        resizeFireworks();

        function startFireworks() {
            fireworksRunning = true;
            animateFireworks();
            const launch = setInterval(() => {
                if (!fireworksRunning) { clearInterval(launch); return; }
                fireworks.push({
                    x: Math.random() * fireworksCanvas.width,
                    y: fireworksCanvas.height,
                    targetY: 100 + Math.random() * 300,
                    speed: 6 + Math.random() * 4,
                    color: `hsl(${Math.random() * 360}, 100%, 60%)`
                });
            }, 200);
        }

        function stopFireworks() {
            fireworksRunning = false;
            fireworks = [];
            particles = [];
            fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
        }

        function animateFireworks() {
            if (!fireworksRunning) return;
            fireworksCtx.fillStyle = 'rgba(0,0,0,0.15)';
            fireworksCtx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);

            fireworks = fireworks.filter(f => {
                f.y -= f.speed;
                fireworksCtx.beginPath();
                fireworksCtx.arc(f.x, f.y, 3, 0, Math.PI * 2);
                fireworksCtx.fillStyle = f.color;
                fireworksCtx.fill();

                if (f.y <= f.targetY) {
                    for (let i = 0; i < 40; i++) {
                        const angle = (Math.PI * 2 / 40) * i;
                        particles.push({
                            x: f.x, y: f.y,
                            vx: Math.cos(angle) * (2 + Math.random() * 3),
                            vy: Math.sin(angle) * (2 + Math.random() * 3),
                            color: f.color, life: 1
                        });
                    }
                    return false;
                }
                return true;
            });

            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.08;
                p.life -= 0.02;
                fireworksCtx.globalAlpha = p.life;
                fireworksCtx.beginPath();
                fireworksCtx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                fireworksCtx.fillStyle = p.color;
                fireworksCtx.fill();
                fireworksCtx.globalAlpha = 1;
                return p.life > 0;
            });

            requestAnimationFrame(animateFireworks);
        }

        // ==================== DECAY ====================
        function startDecay() {
            setInterval(() => {
                if (gameState.isVictoryMode) return;
                Object.keys(countries).forEach(id => {
                    if (countries[id].fillPercent > 0) {
                        updateProgressBar(id, countries[id].fillPercent - CONFIG.decayAmount);
                    }
                });
                updateUI();
            }, CONFIG.decayInterval);

            setInterval(() => {
                gameState.decayTimer--;
                if (gameState.decayTimer <= 0) gameState.decayTimer = 15;
                document.getElementById('decay-timer').textContent = `${gameState.decayTimer}s`;
            }, 1000);
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            document.getElementById('round-number').textContent = gameState.roundNumber;
            document.getElementById('total-actions').textContent = gameState.totalActions;
            updateLeaderboard();
            updateCardWins();
        }

        function updateCardWins() {
            Object.keys(countries).forEach(id => {
                const el = document.getElementById(`wins-${id}`);
                if (el) el.textContent = `${gameState.dailyWins[id] || 0}üèÜ`;
            });
        }

        function updateLeaderboard() {
            const list = document.getElementById('ranking-list');
            const sorted = Object.entries(countries)
                .map(([id, c]) => ({ id, ...c, wins: gameState.dailyWins[id] || 0 }))
                .sort((a, b) => b.wins !== a.wins ? b.wins - a.wins : b.moves - a.moves);

            list.innerHTML = sorted.map((c, i) => `
                <div class="ranking-item" style="--rank-color: ${c.color}; --rank-glow: ${c.glow}">
                    <div class="rank-badge ${i < 3 ? `rank-${i + 1}` : 'rank-other'}">${i + 1}</div>
                    <img class="ranking-image" src="${c.image}" alt="${c.name}" onerror="this.src='https://flagcdn.com/w80/un.png'">
                    <div class="ranking-info">
                        <div class="ranking-name">${c.name}</div>
                        <div class="ranking-percent">${c.moves}/${CONFIG.maxMoves} moves</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="ranking-wins">${c.wins}</div>
                        <div class="ranking-wins-label">wins</div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== FEED & NOTIFICATIONS ====================
        function addFeedItem(user, action, countryId, emoji, type) {
            const feed = document.getElementById('activity-feed');
            const country = countries[countryId];
            const item = document.createElement('div');
            item.className = `feed-item ${type}`;
            item.innerHTML = `
                <span class="feed-emoji">${emoji}</span>
                <span class="feed-user">${user}</span>
                <span class="feed-action">${action}</span>
                <span class="feed-target">${country.flag} ${country.name}</span>
            `;
            feed.insertBefore(item, feed.firstChild);
            while (feed.children.length > 5) feed.removeChild(feed.lastChild);
            setTimeout(() => { if (item.parentNode) item.remove(); }, 6000);
        }

        function showGiftNotification(emoji, text, type) {
            const notif = document.createElement('div');
            notif.className = `gift-notification ${type}`;
            notif.innerHTML = `<span class="emoji">${emoji}</span>${text}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 1200);
        }

        // ==================== WEBSOCKET ====================
        function connectWebSocket() {
            const statusEl = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            statusEl.className = 'connection-status connecting';
            statusText.textContent = 'Connecting...';

            try {
                gameState.ws = new WebSocket(CONFIG.wsUrl);
                gameState.ws.onopen = () => {
                    gameState.connected = true;
                    statusEl.className = 'connection-status connected';
                    statusText.textContent = 'Connected';
                };
                gameState.ws.onclose = () => {
                    gameState.connected = false;
                    statusEl.className = 'connection-status disconnected';
                    statusText.textContent = 'Disconnected';
                    setTimeout(connectWebSocket, 5000);
                };
                gameState.ws.onerror = () => {
                    statusEl.className = 'connection-status disconnected';
                    statusText.textContent = 'Error';
                };
                gameState.ws.onmessage = (e) => {
                    try {
                        processMessage(JSON.parse(e.data));
                    } catch (err) {}
                };
            } catch (e) {
                statusEl.className = 'connection-status disconnected';
                statusText.textContent = 'Failed';
                setTimeout(connectWebSocket, 5000);
            }
        }

        function processMessage(data) {
            const username = data.uniqueId || data.nickname || 'Anonymous';
            
            // Handle comments - check for country name/abbreviation
            if (data.type === 'chat' || data.comment) {
                const comment = data.comment || data.text || '';
                const countryId = findCountryFromComment(comment);
                if (countryId) {
                    handleComment(countryId, username);
                }
            }
            
            // Handle gifts
            if (data.type === 'gift' || data.giftName || data.giftId) {
                const match = findCountryForGift(data.giftName || data.gift, data.giftId || data.gift_id);
                if (match) {
                    if (match.type === 'small') {
                        handleSmallGift(match.countryId, username, data.giftName);
                    } else if (match.type === 'boost') {
                        handleMegaBoost(match.countryId, username, data.giftName);
                    }
                }
            }

            // Handle likes - give +1 move to current leader or random country
            if (data.type === 'like') {
                const countryIds = Object.keys(countries);
                let targetCountry;
                // Find current leader
                let maxMoves = 0;
                countryIds.forEach(id => {
                    if (gameState.moves[id] > maxMoves) {
                        maxMoves = gameState.moves[id];
                        targetCountry = id;
                    }
                });
                // If no leader, pick random
                if (!targetCountry || maxMoves === 0) {
                    targetCountry = countryIds[Math.floor(Math.random() * countryIds.length)];
                }
                addMoves(targetCountry, CONFIG.commentMoves, username);
                addFeedItem(username, '‚ù§Ô∏è like', targetCountry, '‚ù§Ô∏è', 'comment');
            }
        }

        // ==================== CONTROLS ====================
        function testAction(action) {
            if (!gameState.selectedCountry) {
                showGiftNotification('üëÜ', 'Select a country!', 'boost');
                return;
            }
            const user = 'Tester_' + Math.floor(Math.random() * 1000);
            const country = countries[gameState.selectedCountry];
            if (navigator.vibrate) navigator.vibrate(action === 'mega' ? [50, 30, 50, 30, 50] : 30);

            if (action === 'comment') {
                handleComment(gameState.selectedCountry, user);
            } else if (action === 'small') {
                handleSmallGift(gameState.selectedCountry, user, country.smallGifts[0]);
            } else if (action === 'mega') {
                handleMegaBoost(gameState.selectedCountry, user, country.boostGifts[0]);
            }
        }

        function togglePanel() {
            const panel = document.getElementById('control-panel');
            const btn = document.getElementById('toggle-btn');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? '+' : '‚àí';
        }

        function startDemoMode() {
            if (gameState.demoInterval) {
                clearInterval(gameState.demoInterval);
                gameState.demoInterval = null;
                showGiftNotification('‚èπÔ∏è', 'Stopped', 'sabotage');
                return;
            }
            showGiftNotification('‚ñ∂Ô∏è', 'Demo!', 'boost');
            gameState.demoInterval = setInterval(() => {
                if (gameState.isVictoryMode) return;
                const ids = Object.keys(countries);
                const id = ids[Math.floor(Math.random() * ids.length)];
                const users = ['Fan1', 'Pro2', 'Gift3', 'Star4', 'King5', 'Viewer6'];
                const user = users[Math.floor(Math.random() * users.length)];
                
                const rand = Math.random();
                if (rand < 0.5) {
                    // 50% chance: comment
                    handleComment(id, user);
                } else if (rand < 0.9) {
                    // 40% chance: small gift
                    handleSmallGift(id, user, countries[id].smallGifts[0]);
                } else {
                    // 10% chance: mega boost
                    handleMegaBoost(id, user, countries[id].boostGifts[0]);
                }
            }, 300);
        }

        function clearAllWins() {
            if (confirm('Clear all wins?')) {
                gameState.dailyWins = {};
                saveDailyWins();
                updateUI();
                showGiftNotification('üóëÔ∏è', 'Cleared', 'sabotage');
            }
        }

        // ==================== SECRET TEST PANEL TOGGLE ====================
        // Press T key to show/hide test controls (hidden from viewers by default)
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                const panel = document.getElementById('control-panel');
                panel.classList.toggle('visible');
            }
        });

        // ==================== INIT ====================
        function init() {
            createCountryCards();
            updateUI();
            connectWebSocket();
            startDecay();
            startCheerSystem();
            console.log('‚öîÔ∏è Scribble War Progress Bars Ready!');
            console.log('üîä Spanish cheers enabled - tap üîä to mute');
        }

        init();
    </script>
</body>
</html>
