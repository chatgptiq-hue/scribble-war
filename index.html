<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Scribble War - Progress Battle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        body {
            background: linear-gradient(180deg, #0a0a0f 0%, #0d0d15 50%, #0a0a0f 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: #fff;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Main Layout - Split View - ALWAYS HORIZONTAL */
        .container {
            display: flex;
            flex-direction: row !important;
            flex-wrap: nowrap;
            width: 100vw;
            height: 100vh;
            gap: 0;
        }

        /* Main Game Area - Left Side */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 4px 15px;
            overflow: hidden;
            max-width: 65%;
            min-width: 0;
        }

        .game-title {
            text-align: center;
            margin-bottom: 2px;
        }

        .game-title h1 {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-subtitle {
            color: #00ffff;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        /* Vertical Pill Layout */
        .cards-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            flex: 1;
            justify-content: space-evenly;
            padding: 2px 10px;
            width: 100%;
        }

        /* Country Card - Horizontal Row */
        .country-card {
            background: transparent;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }

        .country-card:active {
            transform: scale(0.98);
        }

        .country-card.selected .progress-container {
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.6);
        }

        .country-card.sabotaged {
            animation: sabotageShake 0.5s ease;
        }

        .country-card.sabotaged .progress-container {
            animation: sabotageFlash 0.5s ease;
        }

        @keyframes sabotageShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        @keyframes sabotageFlash {
            0%, 100% { box-shadow: var(--default-shadow); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.9), inset 0 0 20px rgba(255, 0, 0, 0.5); }
        }

        /* Country Name Label - Hidden, name now inside bar */
        .country-label {
            display: none;
        }

        .country-name {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .boost-emoji {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Progress Bar - Pill Shape - Dark Background */
        .progress-container {
            width: 100%;
            height: 44px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            --default-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
            box-shadow: var(--default-shadow), inset 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Country name inside bar */
        .bar-country-name {
            position: absolute;
            right: 38px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255, 255, 255, 1);
            text-shadow: 0 1px 4px rgba(0,0,0,1), 0 0 10px rgba(0,0,0,0.8);
            z-index: 2;
            pointer-events: none;
        }

        .bar-boost-emoji {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            opacity: 1;
            z-index: 2;
            pointer-events: none;
        }

        .gift-icon {
            width: 34px;
            height: 34px;
            object-fit: contain;
            vertical-align: middle;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.7));
        }

        /* Progress Fill - Neon Glow */
        .progress-fill {
            height: 100%;
            width: 0%;
            min-width: 45px;
            border-radius: 50px;
            position: relative;
            transition: width 0.5s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            background: linear-gradient(90deg, var(--country-color), var(--country-color-light, var(--country-color)));
            box-shadow: 
                0 0 20px var(--country-glow),
                0 0 40px var(--country-glow),
                inset 0 2px 10px rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            overflow: visible;
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.35) 0%, transparent 100%);
            border-radius: 50px 50px 0 0;
        }

        /* EPIC Green Glow when moving - Regular moves */
        .progress-fill.moving {
            animation: epicGreenPulse 0.6s ease;
        }

        @keyframes epicGreenPulse {
            0% { 
                box-shadow: 
                    0 0 20px var(--country-glow),
                    0 0 40px var(--country-glow),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
                filter: brightness(1);
            }
            25% { 
                box-shadow: 
                    0 0 40px #00ff00,
                    0 0 80px #00ff00,
                    0 0 120px rgba(0, 255, 0, 0.8),
                    0 0 160px rgba(0, 255, 0, 0.5),
                    inset 0 0 30px rgba(0, 255, 0, 0.6);
                filter: brightness(1.4) saturate(1.5);
                transform: scaleY(1.15);
            }
            50% { 
                box-shadow: 
                    0 0 50px #00ff88,
                    0 0 100px #00ff44,
                    0 0 150px rgba(0, 255, 100, 0.9),
                    0 0 200px rgba(0, 255, 0, 0.6),
                    inset 0 0 40px rgba(0, 255, 0, 0.7);
                filter: brightness(1.6) saturate(1.8);
                transform: scaleY(1.2) scaleX(1.02);
            }
            75% {
                box-shadow: 
                    0 0 35px #00ff00,
                    0 0 70px rgba(0, 255, 0, 0.7),
                    inset 0 0 20px rgba(0, 255, 0, 0.4);
                filter: brightness(1.3);
                transform: scaleY(1.1);
            }
            100% { 
                box-shadow: 
                    0 0 20px var(--country-glow),
                    0 0 40px var(--country-glow),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
                filter: brightness(1);
                transform: scaleY(1) scaleX(1);
            }
        }

        /* MEGA BOOST - Extreme shake, glow, and 3D pop effect */
        .progress-fill.boosting {
            animation: megaBoostExtreme 1s cubic-bezier(0.36, 0.07, 0.19, 0.97);
        }
        
        /* Screen shake for mega boost */
        .screen-shake {
            animation: screenShake 0.6s ease-in-out;
        }
        
        @keyframes screenShake {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-8px, -4px); }
            20% { transform: translate(8px, 4px); }
            30% { transform: translate(-6px, 6px); }
            40% { transform: translate(6px, -6px); }
            50% { transform: translate(-4px, 4px); }
            60% { transform: translate(4px, -4px); }
            70% { transform: translate(-2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0, 0); }
        }
        
        /* Epic pulse on gift */
        .country-card.gift-pulse {
            animation: giftPulse 0.5s ease;
        }
        
        @keyframes giftPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.1); box-shadow: 0 0 30px var(--country-glow, cyan); }
            60% { transform: scale(0.97); }
            100% { transform: scale(1); }
        }

        @keyframes megaBoostExtreme {
            0% { 
                transform: scale(1) translateZ(0);
                box-shadow: 0 0 20px var(--country-glow);
                filter: brightness(1);
            }
            5% { transform: scale(1.05) translateX(-8px) translateY(-2px); }
            10% { transform: scale(1.1) translateX(8px) translateY(2px); }
            15% { transform: scale(1.08) translateX(-10px) translateY(-3px); }
            20% { transform: scale(1.15) translateX(10px) translateY(3px); }
            25% { 
                transform: scale(1.2) translateX(-6px) translateY(-4px) perspective(500px) translateZ(50px);
                box-shadow: 
                    0 0 60px #00ff00,
                    0 0 120px #00ff00,
                    0 0 180px rgba(0, 255, 0, 1),
                    0 0 250px rgba(0, 255, 0, 0.8),
                    0 20px 60px rgba(0, 0, 0, 0.5);
                filter: brightness(2) saturate(2);
            }
            30% { transform: scale(1.25) translateX(6px) translateY(4px) perspective(500px) translateZ(80px); }
            35% { transform: scale(1.22) translateX(-8px) translateY(-2px) perspective(500px) translateZ(100px); }
            40% { 
                transform: scale(1.3) translateX(8px) perspective(500px) translateZ(120px);
                box-shadow: 
                    0 0 80px #00ff44,
                    0 0 160px #00ff00,
                    0 0 240px rgba(0, 255, 100, 1),
                    0 0 320px rgba(0, 255, 0, 0.9),
                    0 30px 80px rgba(0, 0, 0, 0.6);
                filter: brightness(2.5) saturate(2.5);
            }
            50% { 
                transform: scale(1.35) translateY(-5px) perspective(500px) translateZ(150px);
                box-shadow: 
                    0 0 100px #ffffff,
                    0 0 200px #00ff00,
                    0 0 300px rgba(0, 255, 100, 1),
                    0 0 400px rgba(0, 255, 0, 0.8),
                    0 40px 100px rgba(0, 0, 0, 0.7);
                filter: brightness(3) saturate(3) contrast(1.2);
            }
            60% { transform: scale(1.25) translateX(-4px) perspective(500px) translateZ(100px); }
            70% { transform: scale(1.15) translateX(4px) perspective(500px) translateZ(60px); }
            80% { transform: scale(1.08) translateX(-2px) perspective(500px) translateZ(30px); }
            90% { transform: scale(1.03) translateX(2px); }
            100% { 
                transform: scale(1) translateZ(0);
                box-shadow: 0 0 20px var(--country-glow);
                filter: brightness(1);
            }
        }

        /* Card mega-boost effect - whole card pops */
        .country-card.mega-boost {
            z-index: 100;
        }

        .country-card.mega-boost .progress-container {
            animation: containerMegaBoost 1s ease;
        }

        @keyframes containerMegaBoost {
            0%, 100% { 
                box-shadow: var(--default-shadow);
                transform: scale(1);
            }
            30% {
                box-shadow: 
                    0 0 50px #00ff00, 
                    0 0 100px rgba(0, 255, 0, 0.7),
                    0 10px 40px rgba(0, 0, 0, 0.5);
                transform: scale(1.05) translateY(-5px);
            }
            50% { 
                box-shadow: 
                    0 0 80px #00ff00, 
                    0 0 150px rgba(0, 255, 0, 0.9),
                    0 20px 60px rgba(0, 0, 0, 0.6);
                transform: scale(1.08) translateY(-10px);
            }
            70% {
                transform: scale(1.03) translateY(-3px);
            }
        }

        .country-card.mega-boost .country-image {
            animation: imageMegaBoost 1s ease;
        }

        @keyframes imageMegaBoost {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            20% { transform: scale(1.3) rotate(-15deg); filter: brightness(1.5); }
            40% { transform: scale(1.5) rotate(15deg); filter: brightness(2); }
            50% { transform: scale(1.6) rotate(-10deg); filter: brightness(2.5) drop-shadow(0 0 20px #00ff00); }
            60% { transform: scale(1.4) rotate(10deg); filter: brightness(2); }
            80% { transform: scale(1.2) rotate(-5deg); filter: brightness(1.3); }
        }

        /* Screen flash for mega boost */
        .mega-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0,255,0,0.4) 0%, transparent 70%);
            pointer-events: none;
            z-index: 900;
            opacity: 0;
        }

        .mega-flash.active {
            animation: megaFlash 0.5s ease;
        }

        @keyframes megaFlash {
            0% { opacity: 0; }
            30% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Country Image on Bar */
        .country-image {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: -3px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 10px var(--country-glow), 0 3px 8px rgba(0,0,0,0.4);
            flex-shrink: 0;
            z-index: 5;
            animation: imagePulse 2s ease-in-out infinite;
            background: #1a1a2e;
        }

        @keyframes imagePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .country-card:hover .country-image {
            animation: imageHover 0.3s ease forwards;
        }

        @keyframes imageHover {
            to { transform: scale(1.15); }
        }

        /* Percentage Text - Inside Bar Left */
        .progress-text {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 15px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
            z-index: 2;
        }

        /* ==================== LEADERBOARD - RIGHT SIDE ==================== */
        .leaderboard {
            width: 35%;
            min-width: 0;
            max-width: 320px;
            background: linear-gradient(180deg, rgba(20, 20, 35, 0.98) 0%, rgba(10, 10, 20, 0.98) 100%);
            border-left: 3px solid #00ffff;
            padding: 4px 12px;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 255, 255, 0.15);
            overflow: hidden;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
        }

        .leaderboard h2 {
            color: #00ffff;
            font-size: 22px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .leaderboard-subtitle {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .ranking-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ranking-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--rank-color);
            border-radius: 15px 0 0 15px;
        }

        .ranking-item:hover {
            background: rgba(0, 255, 255, 0.08);
            transform: translateX(-3px);
        }

        .rank-badge {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 900;
            font-size: 12px;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .rank-2 { background: linear-gradient(135deg, #e0e0e0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-other { background: rgba(0, 255, 255, 0.15); color: #00ffff; }

        /* Circular Image in Leaderboard */
        .ranking-image {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            border: 2px solid var(--rank-color, #00ffff);
            box-shadow: 0 0 8px var(--rank-glow, rgba(0, 255, 255, 0.3));
            flex-shrink: 0;
            background: #1a1a2e;
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-name {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-percent {
            font-size: 10px;
            color: #888;
            margin-top: 1px;
        }

        .ranking-wins {
            font-size: 24px;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            margin-left: 10px;
        }

        .ranking-wins-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Stats Panel */
        /* Stats Panel - Hidden from viewers */
        .stats-panel {
            display: none;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 2px solid rgba(0, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 5px;
            font-size: 11px;
            color: #888;
        }

        .stat-value {
            color: #00ffff;
            font-weight: bold;
            font-size: 12px;
        }

        .connection-status {
            display: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .connected .status-dot { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .disconnected .status-dot { background: #ff0000; animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }

        /* Hidden elements */
        .country-header,
        .gift-hints,
        .country-info,
        .country-flag {
            display: none;
        }

        /* Leaderboard Sidebar */
        .leaderboard {
            width: 35%;
            min-width: 0;
            background: linear-gradient(180deg, #12121a 0%, #0a0a0f 100%);
            border-left: 2px solid #00ffff;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 30px rgba(0, 255, 255, 0.1);
            overflow: hidden;
        }

        .leaderboard h2 {
            text-align: center;
            color: #00ffff;
            font-size: 22px;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .leaderboard-subtitle {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .ranking-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        .rank-badge {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 6px;
            font-size: 12px;
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-other { background: rgba(0, 255, 255, 0.2); color: #00ffff; }

        .ranking-flag {
            font-size: 18px;
            margin-right: 6px;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .ranking-percent {
            font-size: 10px;
            color: #888;
        }

        .ranking-wins {
            font-size: 22px;
            font-weight: bold;
            color: #ffd700;
        }

        .stats-panel {
            display: none;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 10px;
            color: #888;
        }

        .stat-value {
            color: #00ffff;
            font-weight: bold;
        }

        .connection-status {
            display: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .connected .status-dot { background: #00ff00; }
        .disconnected .status-dot { background: #ff0000; animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Victory Overlay */
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.98) 100%);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }

        .victory-overlay.active {
            display: flex;
            animation: victoryFadeIn 0.5s ease;
        }

        @keyframes victoryFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .victory-image {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 25px;
            border: 6px solid #ffd700;
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.8),
                0 0 80px rgba(255, 215, 0, 0.5),
                0 0 120px rgba(255, 215, 0, 0.3);
            animation: victoryImageBounce 0.5s ease infinite alternate;
        }

        @keyframes victoryImageBounce {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(5deg); }
        }

        .victory-title {
            font-size: 56px;
            font-weight: 900;
            color: #ffd700;
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4);
            margin-bottom: 10px;
            animation: victoryTitleGlow 0.5s ease infinite alternate;
        }

        @keyframes victoryTitleGlow {
            from { 
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 215, 0, 0.8), 0 0 120px rgba(255, 215, 0, 0.6);
                transform: scale(1.02);
            }
        }

        .victory-country {
            font-size: 48px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: victoryCountryPulse 1s ease infinite;
        }

        @keyframes victoryCountryPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .victory-contributor {
            font-size: 24px;
            color: #00ffff;
            margin-bottom: 30px;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .victory-timer {
            font-size: 28px;
            color: #888;
            animation: timerPulse 1s ease infinite;
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fireworks */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* Activity Feed */
        .activity-feed {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 300px;
            max-height: 150px;
            overflow: hidden;
            z-index: 100;
        }

        .feed-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 10px;
            font-size: 12px;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 3px solid;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .feed-item.boost { border-color: #00ff88; }
        .feed-item.sabotage { border-color: #ff4444; }

        .feed-emoji { font-size: 16px; }
        .feed-user { color: #00ffff; font-weight: bold; }
        .feed-action { color: #888; }
        .feed-target { font-weight: 600; }
        .feed-item.boost .feed-target { color: #00ff88; }
        .feed-item.sabotage .feed-target { color: #ff4444; }

        /* Gift Notification */
        .gift-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            z-index: 500;
            animation: popIn 1.2s ease forwards;
            pointer-events: none;
            text-align: center;
        }

        .gift-notification .emoji { font-size: 70px; display: block; }
        .gift-notification.boost { color: #00ff88; text-shadow: 0 0 30px rgba(0, 255, 136, 0.8); }
        .gift-notification.comment { color: #6366f1; text-shadow: 0 0 30px rgba(99, 102, 241, 0.8); }
        .gift-notification.mega { 
            color: #ffcc00; 
            text-shadow: 0 0 40px rgba(255, 200, 0, 1), 0 0 80px rgba(255, 102, 0, 0.8);
            animation: megaNotification 1.5s ease forwards;
        }

        @keyframes megaNotification {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(-10deg); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.4) rotate(5deg); }
            40% { transform: translate(-50%, -50%) scale(1.2) rotate(-3deg); }
            60% { transform: translate(-50%, -50%) scale(1.3) rotate(2deg); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9) translateY(-50px); }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            70% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8) translateY(-40px); }
        }

        /* Touch Control Panel */
        .control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 20, 0.98);
            border-top: 3px solid #ff6600;
            z-index: 1001;
            transition: transform 0.3s ease;
            max-height: 50vh;
            display: none;
        }
        .control-panel.visible {
            display: block;
        }

        .control-panel.minimized {
            transform: translateY(calc(100% - 50px));
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(90deg, #ff660033, transparent);
            min-height: 50px;
            cursor: pointer;
        }

        .panel-header span {
            font-weight: bold;
            color: #ff6600;
            font-size: 16px;
        }

        .toggle-btn {
            background: #ff6600;
            border: none;
            color: #000;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .panel-content {
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            min-width: 90px;
        }

        .action-btn small { font-size: 11px; opacity: 0.9; display: block; margin-top: 2px; }
        .comment-btn { background: linear-gradient(135deg, #6366f1, #4f46e5); box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); }
        .boost-btn { background: linear-gradient(135deg, #00c853, #009624); box-shadow: 0 4px 20px rgba(0, 200, 83, 0.4); }
        .mega-btn { 
            background: linear-gradient(135deg, #ff6600, #ff9500, #ffcc00); 
            box-shadow: 0 4px 20px rgba(255, 102, 0, 0.5);
            animation: megaBtnPulse 2s ease infinite;
        }
        @keyframes megaBtnPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(255, 102, 0, 0.5); }
            50% { box-shadow: 0 4px 35px rgba(255, 200, 0, 0.7); }
        }
        .action-btn:active { transform: scale(0.95); }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex-shrink: 0;
        }

        .quick-btn {
            padding: 15px 20px;
            border: 2px solid #444;
            border-radius: 12px;
            background: #2a2a3e;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        .quick-btn:active { background: #4a4a5e; border-color: #ff6600; }

        /* Responsive - ALWAYS landscape side-by-side */
        @media (max-width: 1000px) {
            .game-area { max-width: 60%; padding: 5px 8px; }
            .leaderboard { width: 40%; min-width: 0; max-width: none; padding: 5px 8px; }
            .progress-container { height: 38px; }
            .country-image { width: 38px; height: 38px; }
            .ranking-wins { font-size: 20px; }
            .ranking-image { width: 28px; height: 28px; }
            .ranking-name { font-size: 12px; }
            .game-title h1 { font-size: 20px; letter-spacing: 2px; }
            .game-subtitle { font-size: 12px; }
            .leaderboard h2 { font-size: 18px; }
            .leaderboard-subtitle { font-size: 10px; }
            .bar-country-name { font-size: 12px; right: 32px; }
            .gift-icon { width: 28px; height: 28px; }
            .progress-text { font-size: 12px; }
        }

        @media (max-width: 700px) {
            .game-area { max-width: 58%; padding: 4px 6px; }
            .leaderboard { width: 42%; min-width: 0; padding: 4px 6px; }
            .progress-container { height: 32px; }
            .country-image { width: 32px; height: 32px; }
            .bar-country-name { font-size: 10px; right: 26px; }
            .bar-boost-emoji { font-size: 14px; right: 5px; }
            .gift-icon { width: 24px; height: 24px; }
            .progress-text { font-size: 10px; left: 8px; }
            .game-title h1 { font-size: 16px; }
            .game-subtitle { font-size: 10px; }
            .ranking-item { padding: 4px 6px; }
            .rank-badge { width: 20px; height: 20px; font-size: 10px; margin-right: 4px; }
            .ranking-image { width: 24px; height: 24px; margin-right: 5px; }
            .ranking-name { font-size: 11px; }
            .ranking-percent { font-size: 8px; }
            .ranking-wins { font-size: 16px; }
            .leaderboard h2 { font-size: 14px; letter-spacing: 1px; }
            .leaderboard-subtitle { font-size: 8px; }
            .leaderboard-header { margin-bottom: 4px; padding-bottom: 4px; }
        }

        @media (max-width: 500px) {
            .game-area { max-width: 55%; padding: 3px 4px; }
            .leaderboard { width: 45%; min-width: 0; padding: 3px 4px; }
            .progress-container { height: 26px; }
            .country-image { width: 26px; height: 26px; border-width: 1px; }
            .bar-country-name { font-size: 8px; right: 22px; }
            .bar-boost-emoji { font-size: 11px; right: 3px; }
            .gift-icon { width: 20px; height: 20px; }
            .progress-text { font-size: 9px; left: 5px; }
            .cards-grid { gap: 1px; padding: 1px 3px; }
            .game-title h1 { font-size: 13px; letter-spacing: 1px; }
            .game-subtitle { font-size: 8px; }
            .ranking-item { padding: 3px 4px; border-radius: 6px; }
            .rank-badge { width: 16px; height: 16px; font-size: 8px; margin-right: 3px; }
            .ranking-image { width: 18px; height: 18px; margin-right: 3px; border-width: 1px; }
            .ranking-name { font-size: 9px; }
            .ranking-wins { font-size: 14px; }
            .leaderboard h2 { font-size: 11px; }
            .leaderboard-subtitle { font-size: 7px; }
        }

        /* Hide control panel on small heights */
        @media (max-height: 700px) {
            .control-panel { display: none; }
            .activity-feed { bottom: 10px; left: 10px; width: 250px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(0, 255, 255, 0.3); border-radius: 3px; }

        /* Cheer Notification */
        .cheer-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 165, 0, 0.95));
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 600;
            animation: cheerSlide 4s ease forwards;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.4);
            max-width: 90vw;
        }

        .cheer-flag {
            font-size: 40px;
            animation: cheerBounce 0.5s ease infinite alternate;
        }

        .cheer-text {
            font-size: 18px;
            font-weight: bold;
            color: #000;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
        }

        @keyframes cheerSlide {
            0% { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        @keyframes cheerBounce {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.1) rotate(5deg); }
        }

        /* Audio Toggle Button */
        .audio-toggle {
            display: none;
        }

        .audio-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 30px rgba(0, 255, 255, 0.5);
        }

        .audio-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 900px) {
            .audio-toggle {
                top: 10px;
                right: 10px;
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            .cheer-notification {
                top: 60px;
                padding: 10px 20px;
            }
            .cheer-flag { font-size: 30px; }
            .cheer-text { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Game Area -->
        <div class="game-area">
            <div class="game-title">
                <h1>‚öîÔ∏è BATALLA LATINA ‚öîÔ∏è</h1>
                <div class="game-subtitle">Comenta el nombre de tu pa√≠s ‚Ä¢ ¬°500 para ganar!</div>
            </div>

            <!-- 3x3 Grid of Country Cards -->
            <div class="cards-grid" id="cards-grid"></div>
        </div>

        <!-- Leaderboard Sidebar - Right Side -->
        <div class="leaderboard">
            <div class="leaderboard-header">
                <h2>üèÜ VICTORIAS</h2>
                <div class="leaderboard-subtitle">Ranking del D√≠a</div>
            </div>
            <div class="ranking-list" id="ranking-list"></div>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <span>Ronda</span>
                    <span class="stat-value" id="round-number">1</span>
                </div>
                <div class="stat-item">
                    <span>Acciones</span>
                    <span class="stat-value" id="total-actions">0</span>
                </div>
                <div class="stat-item">
                    <span>Decay</span>
                    <span class="stat-value" id="decay-timer">15s</span>
                </div>
            </div>
            
            <div class="connection-status disconnected" id="connection-status">
                <span class="status-dot"></span>
                <span id="status-text">Desconectado</span>
            </div>
        </div>
    </div>

    <!-- Audio Toggle Button -->
    <button class="audio-toggle" id="audio-toggle" onclick="toggleAudio()" title="Mute cheers">üîä</button>

    <!-- Activity Feed -->
    <div class="activity-feed" id="activity-feed"></div>

    <!-- Victory Overlay -->
    <div class="victory-overlay" id="victory-overlay">
        <img class="victory-image" id="victory-image" src="" alt="Winner">
        <div class="victory-title">üéâ ¬°GANADOR! üéâ</div>
        <div class="victory-country" id="victory-country">Country</div>
        <div class="victory-contributor" id="victory-contributor">Mejor jugador: User</div>
        <div class="victory-timer" id="victory-timer">Nueva ronda en 10s</div>
    </div>

    <!-- Fireworks -->
    <canvas id="fireworks-canvas"></canvas>

    <!-- Mega Boost Flash -->
    <div class="mega-flash" id="mega-flash"></div>

    <!-- Touch Control Panel -->
    <div class="control-panel" id="control-panel">
        <div class="panel-header" onclick="togglePanel()">
            <span>üéÆ TAP COUNTRY ABOVE ‚Ä¢ THEN ACTION BELOW</span>
            <button class="toggle-btn" id="toggle-btn">‚àí</button>
        </div>
        <div class="panel-content" id="panel-content">
            <div class="action-buttons">
                <button class="action-btn comment-btn" onclick="testAction('comment')">
                    üí¨ Comentar<small>+1 move</small>
                </button>
                <button class="action-btn boost-btn" onclick="testAction('small')">
                    üéÅ Regalo<small>+2 moves</small>
                </button>
                <button class="action-btn mega-btn" onclick="testAction('mega')">
                    üöÄ MEGA BOOST<small>+125 moves</small>
                </button>
            </div>
            <div class="quick-actions">
                <button class="quick-btn" onclick="testCheer()">üì¢ Next</button>
                <button class="quick-btn" onclick="testAllCheers()">üîä Test All</button>
                <button class="quick-btn" onclick="startDemoMode()">‚ñ∂Ô∏è Demo</button>
                <button class="quick-btn" onclick="resetRound()">üîÑ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            wsUrl: 'ws://localhost:21213',
            decayInterval: 15000,
            decayAmount: 1.5,
            victoryDuration: 45000,
            maxMoves: 500, // Total moves to win
            commentMoves: 1, // Comment = 1 move
            smallGiftMoves: 2, // 1-coin gift = 2 moves
            boostMoves: 125, // 100-coin gift = 125 moves
            sabotageAmount: 25 // Still percentage based
        };

        // ==================== COUNTRY DATA ====================
        const countries = {
            colombia: {
                name: 'Colombia',
                flag: 'üá®üá¥',
                abbr: ['co', 'col'],
                color: '#fcd116',
                glow: 'rgba(252, 209, 22, 0.5)',
                image: 'https://flagcdn.com/w160/co.png',
                moves: 0,
                contributors: {},
                smallGifts: ['gg', '5905'], // 1-coin
                boostGifts: ['little crown', 'crown', '5830'], // 99-coin
                smallEmoji: 'üéÆ',
                giftImage: 'gifts/GG.png',
                boostEmoji: 'üëë'
            },
            venezuela: {
                name: 'Venezuela',
                flag: 'üáªüá™',
                abbr: ['ve', 'ven'],
                color: '#cf142b',
                glow: 'rgba(207, 20, 43, 0.5)',
                image: 'https://flagcdn.com/w160/ve.png',
                moves: 0,
                contributors: {},
                smallGifts: ['lightning bolt', 'lightning', 'bolt', '5765'], // 1-coin
                boostGifts: ['cap', '5829'], // 99-coin
                smallEmoji: '‚ö°',
                giftImage: 'gifts/Lightning%20Bolt.png',
                boostEmoji: 'üß¢'
            },
            ecuador: {
                name: 'Ecuador',
                flag: 'üá™üá®',
                abbr: ['ec', 'ecu'],
                color: '#ffd100',
                glow: 'rgba(255, 209, 0, 0.5)',
                image: 'https://flagcdn.com/w160/ec.png',
                moves: 0,
                contributors: {},
                smallGifts: ['ice cream cone', 'ice cream', 'icecream', '5826'], // 1-coin
                boostGifts: ['paper crane', 'crane', '5900'], // 99-coin
                smallEmoji: 'üç¶',
                giftImage: 'gifts/Ice%20Cream%20Cone.png',
                boostEmoji: 'ü¶¢'
            },
            mexico: {
                name: 'M√©xico',
                flag: 'üá≤üáΩ',
                abbr: ['mx', 'mex'],
                color: '#006847',
                glow: 'rgba(0, 104, 71, 0.5)',
                image: 'https://flagcdn.com/w160/mx.png',
                moves: 0,
                contributors: {},
                smallGifts: ['rose', '5655'], // 1-coin
                boostGifts: ['singing magic', 'singing', 'magic', '5878'], // 100-coin
                smallEmoji: 'üåπ',
                giftImage: 'gifts/Rose.png',
                boostEmoji: 'üé§'
            },
            elsalvador: {
                name: 'El Salvador',
                flag: 'üá∏üáª',
                abbr: ['sv', 'sal'],
                color: '#0047ab',
                glow: 'rgba(0, 71, 171, 0.5)',
                image: 'https://flagcdn.com/w160/sv.png',
                moves: 0,
                contributors: {},
                smallGifts: ['heart puff', 'heartpuff', 'puff', '5659'], // 1-coin
                boostGifts: ['confetti', '5839'], // 100-coin
                smallEmoji: 'üíó',
                giftImage: 'gifts/Heart%20Puff.png',
                boostEmoji: 'üéâ'
            },
            nicaragua: {
                name: 'Nicaragua',
                flag: 'üá≥üáÆ',
                abbr: ['ni', 'nic'],
                color: '#17c3b2',
                glow: 'rgba(23, 195, 178, 0.5)',
                image: 'https://flagcdn.com/w160/ni.png',
                moves: 0,
                contributors: {},
                smallGifts: ['you\'re awesome', 'youre awesome', 'awesome', '5661'], // 1-coin
                boostGifts: ['super gg', 'supergg', '5879'], // 100-coin
                smallEmoji: 'üåü',
                giftImage: 'gifts/You%27re%20Awesome.png',
                boostEmoji: 'üèÜ'
            },
            guatemala: {
                name: 'Guatemala',
                flag: 'üá¨üáπ',
                abbr: ['gt', 'gua'],
                color: '#4997d0',
                glow: 'rgba(73, 151, 208, 0.5)',
                image: 'https://flagcdn.com/w160/gt.png',
                moves: 0,
                contributors: {},
                smallGifts: ['wink wink', 'winkwink', 'wink', '5827'], // 1-coin
                boostGifts: ['hand hearts', 'handhearts', 'hand heart', '5880'], // 100-coin
                smallEmoji: 'üòâ',
                giftImage: 'gifts/Wink%20Wink.png',
                boostEmoji: 'ü´∂'
            },
            peru: {
                name: 'Per√∫',
                flag: 'üáµüá™',
                abbr: ['pe', 'per'],
                color: '#d91023',
                glow: 'rgba(217, 16, 35, 0.5)',
                image: 'https://flagcdn.com/w160/pe.png',
                moves: 0,
                contributors: {},
                smallGifts: ['goat', '5904'], // 1-coin
                boostGifts: ['game controller', 'controller', 'gamecontroller', '5881'], // 100-coin
                smallEmoji: 'üêê',
                giftImage: 'gifts/GOAT.png',
                boostEmoji: 'üéÆ'
            },
            puertorico: {
                name: 'Puerto Rico',
                flag: 'üáµüá∑',
                abbr: ['pr', 'pur'],
                color: '#eb4034',
                glow: 'rgba(235, 64, 52, 0.5)',
                image: 'https://flagcdn.com/w160/pr.png',
                moves: 0,
                contributors: {},
                smallGifts: ['tiktok', 'tiktok logo', 'tik tok', '5906'], // 1-coin
                boostGifts: ['marvelous confetti', 'marvelous', '5882'], // 100-coin
                smallEmoji: 'üéµ',
                giftImage: 'gifts/TikTok.png',
                boostEmoji: 'üéä'
            },
            dominicana: {
                name: 'Rep. Dominicana',
                flag: 'üá©üá¥',
                abbr: ['do', 'dom', 'rd'],
                color: '#002d62',
                glow: 'rgba(0, 45, 98, 0.5)',
                image: 'https://flagcdn.com/w160/do.png',
                moves: 0,
                contributors: {},
                smallGifts: ['live', '5659'], // 1-coin
                boostGifts: ['bowknot', 'bow', '5883'], // 100-coin
                smallEmoji: 'üî¥',
                giftImage: 'gifts/LIVE.png',
                boostEmoji: 'üéÄ'
            },
            chile: {
                name: 'Chile',
                flag: 'üá®üá±',
                abbr: ['cl', 'chi'],
                color: '#d52b1e',
                glow: 'rgba(213, 43, 30, 0.5)',
                image: 'https://flagcdn.com/w160/cl.png',
                moves: 0,
                contributors: {},
                smallGifts: ['chili', 'chilli', 'chilli pepper', 'pepper', '5660'], // 1-coin
                boostGifts: ['mishka bear', 'mishka', 'bear', '5879'], // 100-coin
                smallEmoji: 'üå∂Ô∏è',
                giftImage: 'gifts/Chili.png',
                boostEmoji: 'üß∏'
            },
            trump: {
                name: 'United States',
                flag: 'üá∫üá∏',
                abbr: ['us', 'usa', 'trump'],
                color: '#ff6600',
                glow: 'rgba(255, 102, 0, 0.5)',
                image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Donald_Trump_official_portrait.jpg/220px-Donald_Trump_official_portrait.jpg',
                moves: 0,
                contributors: {},
                smallGifts: ['it\'s corn', 'its corn', 'corn', '5765'], // 1-coin
                boostGifts: ['hat and mustache', 'hat mustache', 'mustache', '5884'], // 99-coin
                smallEmoji: 'üåΩ',
                giftImage: 'gifts/It%27s%20Corn.png',
                boostEmoji: 'üé©'
            }
        };

        // ==================== GAME STATE ====================
        let gameState = {
            roundNumber: 1,
            totalActions: 0,
            isVictoryMode: false,
            dailyWins: loadDailyWins(),
            decayTimer: 15,
            selectedCountry: null,
            ws: null,
            connected: false,
            demoInterval: null,
            currentLeader: null,
            cheerInterval: null,
            lastCheerTime: 0
        };

        // ==================== SPANISH CHEERS ====================
        const countryChants = {
            colombia: [
                "¬°Vamos Colombia, t√∫ puedes ganar!",
                "¬°Colombia, Colombia, ole ole ol√©!",
                "¬°S√≠ se puede, s√≠ se puede, Colombia!",
                "¬°Este es el pa√≠s de Colombia!"
            ],
            venezuela: [
                "¬°Vamos la vinotinto, vamos a ganar!",
                "¬°Venezuela, Venezuela, esta barra te quiere!",
                "¬°Arriba Venezuela, vamos a ganar!",
                "¬°Vinotinto te llevo en el coraz√≥n!"
            ],
            ecuador: [
                "¬°S√≠ se puede Ecuador, s√≠ se puede!",
                "¬°Ecuador, Ecuador, ole ole ol√©!",
                "¬°Vamos tricolor, vamos a ganar!",
                "¬°Ecuador mi pa√≠s, te llevo en mi coraz√≥n!"
            ],
            mexico: [
                "¬°Vamos vamos M√©xico, a la delantera!",
                "¬°Cielito lindo, M√©xico, M√©xico!",
                "¬°S√≠ se puede, s√≠ se puede, M√©xico!",
                "¬°M√©xico, M√©xico, ra ra ra!"
            ],
            elsalvador: [
                "¬°Vamos vamos la selecta, vamos a ganar!",
                "¬°El Salvador, El Salvador, ole ole ol√©!",
                "¬°Pulgarcito de Am√©rica, adelante!",
                "¬°Arriba la selecta, vamos a ganar!"
            ],
            nicaragua: [
                "¬°Arriba los pinoleros, vamos a ganar!",
                "¬°Nicaragua, Nicaragua, s√≠ se puede!",
                "¬°Vamos azul y blanco, adelante!",
                "¬°Nicaragua campe√≥n, s√≠ se puede!"
            ],
            guatemala: [
                "¬°Vamos la azul y blanco, vamos a ganar!",
                "¬°Guatemala, Guatemala, ole ole ol√©!",
                "¬°Arriba los chapines, s√≠ se puede!",
                "¬°Guate, Guate, vamos Guate!"
            ],
            peru: [
                "¬°Arriba Per√∫, arriba arriba!",
                "¬°Per√∫, Per√∫, Per√∫, contigo Per√∫!",
                "¬°Vamos blanquirroja, vamos a ganar!",
                "¬°Como no te voy a querer, Per√∫!"
            ],
            puertorico: [
                "¬°Puerto Rico, lo hace mejor!",
                "¬°Wepa wepa, Puerto Rico!",
                "¬°Boricua, boricua, dale dale!",
                "¬°Puerto Rico me encanta!"
            ],
            dominicana: [
                "¬°Quisqueya la bella, arriba!",
                "¬°Dominicana, Dominicana, s√≠ se puede!",
                "¬°Aqu√≠ lleg√≥ la quisqueya!",
                "¬°Rep√∫blica Dominicana, a ganar!"
            ],
            chile: [
                "¬°Chi chi chi, le le le, viva Chile!",
                "¬°Vamos chilenos, vamos a ganar!",
                "¬°Chile, Chile, lindo Chile!",
                "¬°Ceache√≠, ceache√≠, viva Chile!"
            ],
            trump: [
                "Chi-na! Chi-na! Chi-na!",
                "Money money money! Trump is winning!",
                "Make America Great Again!",
                "We're winning, we're winning big league!",
                "Tremendous! Absolutely tremendous!"
            ]
        };

        let speechEnabled = true;
        let speechReady = false;
        let voices = [];

        // Initialize speech synthesis
        function initSpeech() {
            if (!window.speechSynthesis) {
                console.log('Speech synthesis not supported');
                return;
            }

            // Load voices
            voices = window.speechSynthesis.getVoices();
            
            // Chrome loads voices async
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    voices = window.speechSynthesis.getVoices();
                    console.log('Voices loaded:', voices.length);
                    speechReady = true;
                };
            } else {
                speechReady = true;
            }

            // Unlock audio on first user interaction
            const unlockAudio = () => {
                if (window.speechSynthesis) {
                    const unlock = new SpeechSynthesisUtterance('');
                    unlock.volume = 0;
                    window.speechSynthesis.speak(unlock);
                    console.log('Speech unlocked');
                }
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
            };

            document.addEventListener('click', unlockAudio);
            document.addEventListener('touchstart', unlockAudio);
        }

        function speakCheer(countryId, force = false) {
            if (!speechEnabled || gameState.isVictoryMode) return;
            
            const now = Date.now();
            // Don't cheer more often than every 8 seconds (unless forced)
            if (!force && now - gameState.lastCheerTime < 8000) return;
            gameState.lastCheerTime = now;

            const chants = countryChants[countryId];
            if (!chants) return;

            const chant = chants[Math.floor(Math.random() * chants.length)];
            const country = countries[countryId];

            // Show visual notification regardless of audio
            showCheerNotification(country.flag, chant);

            // Try speech synthesis
            if (window.speechSynthesis) {
                try {
                    window.speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(chant);
                    
                    // Find the right voice FIRST
                    const currentVoices = window.speechSynthesis.getVoices();
                    let voice;
                    
                    if (countryId === 'trump') {
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        utterance.pitch = 0.8;
                        voice = currentVoices.find(v => v.lang === 'en-US') || 
                                currentVoices.find(v => v.lang.startsWith('en'));
                    } else {
                        utterance.lang = 'es-MX';
                        utterance.rate = 1.0;
                        utterance.pitch = 1.1;
                        voice = currentVoices.find(v => v.lang === 'es-MX') ||
                                currentVoices.find(v => v.lang === 'es-419') ||
                                currentVoices.find(v => v.lang === 'es-US') ||
                                currentVoices.find(v => v.lang === 'es-ES') || 
                                currentVoices.find(v => v.lang.startsWith('es'));
                        
                        // If no Spanish voice found, DON'T speak in English - just skip
                        if (!voice) {
                            console.log('‚ö†Ô∏è No Spanish voice available - skipping speech');
                            return;
                        }
                    }
                    
                    utterance.volume = 1.0;
                    if (voice) {
                        utterance.voice = voice;
                        console.log('Using voice:', voice.name, voice.lang);
                    }

                    utterance.onerror = (e) => {
                        console.log('Speech error:', e.error);
                    };

                    window.speechSynthesis.speak(utterance);
                    console.log('Speaking:', chant);

                } catch (e) {
                    console.log('Speech failed:', e);
                }
            }
        }

        // Fallback: No sound (removed annoying ping)
        function playCheerTone(countryId) {
            // Intentionally silent - speech synthesis handles audio
        }

        function showCheerNotification(flag, text) {
            const notif = document.createElement('div');
            notif.className = 'cheer-notification';
            notif.innerHTML = `<span class="cheer-flag">${flag}</span><span class="cheer-text">${text}</span>`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 4000);
        }

        function checkLeaderAndCheer() {
            if (gameState.isVictoryMode) return;

            let leader = null;
            let maxMoves = 0;

            Object.entries(countries).forEach(([id, country]) => {
                if (country.moves > maxMoves && country.moves > 10) {
                    maxMoves = country.moves;
                    leader = id;
                }
            });

            // If leader changed, announce it
            if (leader && leader !== gameState.currentLeader) {
                gameState.currentLeader = leader;
                speakCheer(leader);
            }
        }

        // Periodic cheer for current leader (every 15-20 seconds)
        function startCheerSystem() {
            initSpeech();

            gameState.cheerInterval = setInterval(() => {
                if (gameState.currentLeader && !gameState.isVictoryMode) {
                    speakCheer(gameState.currentLeader);
                }
            }, 15000 + Math.random() * 5000);
        }

        function toggleAudio() {
            speechEnabled = !speechEnabled;
            const btn = document.getElementById('audio-toggle');
            btn.textContent = speechEnabled ? 'üîä' : 'üîá';
            btn.title = speechEnabled ? 'Mute cheers' : 'Enable cheers';
            
            if (!speechEnabled && window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            showGiftNotification(speechEnabled ? 'üîä' : 'üîá', speechEnabled ? 'Audio ON' : 'Audio OFF', 'boost');
        }

        // Test button to manually trigger cheers - cycles through all countries
        let testCheerIndex = 0;
        const countryIds = ['colombia', 'venezuela', 'ecuador', 'mexico', 'elsalvador', 'nicaragua', 'guatemala', 'peru', 'puertorico', 'dominicana', 'chile', 'trump'];

        function testCheer() {
            const id = countryIds[testCheerIndex];
            testCheerIndex = (testCheerIndex + 1) % countryIds.length;
            
            // Force the cheer even if one just played
            gameState.lastCheerTime = 0;
            speakCheer(id, true);
        }

        // Test all countries in sequence
        let testAllInterval = null;
        
        function testAllCheers() {
            if (testAllInterval) {
                clearInterval(testAllInterval);
                testAllInterval = null;
                showGiftNotification('‚èπÔ∏è', 'Stopped', 'sabotage');
                return;
            }
            
            testCheerIndex = 0;
            showGiftNotification('üîä', 'Testing All!', 'boost');
            
            // Play first one immediately
            testCheer();
            
            // Then cycle through rest every 5 seconds
            testAllInterval = setInterval(() => {
                if (testCheerIndex === 0) {
                    // We've gone through all, stop
                    clearInterval(testAllInterval);
                    testAllInterval = null;
                    showGiftNotification('‚úÖ', 'Test Done!', 'boost');
                    return;
                }
                testCheer();
            }, 5000);
        }

        // ==================== STORAGE ====================
        function loadDailyWins() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('scribbleWar_dailyWins');
            if (stored) {
                const data = JSON.parse(stored);
                if (data.date === today) return data.wins;
            }
            return {};
        }

        function saveDailyWins() {
            localStorage.setItem('scribbleWar_dailyWins', JSON.stringify({
                date: new Date().toDateString(),
                wins: gameState.dailyWins
            }));
        }

        // ==================== UI GENERATION ====================
        function createCountryCards() {
            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';

            Object.entries(countries).forEach(([id, country]) => {
                const card = document.createElement('div');
                card.className = 'country-card';
                card.id = `card-${id}`;
                card.style.setProperty('--country-color', country.color);
                card.style.setProperty('--country-glow', country.glow);
                card.style.setProperty('--country-color-light', country.color + 'cc');
                
                card.innerHTML = `
                    <div class="country-label">
                        <span class="country-name">${country.name}</span>
                        <span class="boost-emoji">${country.boostEmoji}</span>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" id="fill-${id}">
                            <img class="country-image" src="${country.image}" alt="${country.name}" onerror="this.src='https://flagcdn.com/w160/un.png'">
                        </div>
                        <span class="progress-text" id="text-${id}">0%</span>
                        <span class="bar-country-name">${country.name}</span>
                        <span class="bar-boost-emoji">${country.giftImage ? `<img class="gift-icon" src="${country.giftImage}" alt="">` : country.smallEmoji}</span>
                    </div>
                `;

                card.onclick = () => selectCountry(id);
                card.ontouchstart = (e) => {
                    e.preventDefault();
                    selectCountry(id);
                };

                grid.appendChild(card);
            });

            selectCountry('colombia');
        }

        function selectCountry(countryId) {
            gameState.selectedCountry = countryId;

            document.querySelectorAll('.country-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.getElementById(`card-${countryId}`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            if (navigator.vibrate) navigator.vibrate(20);
        }

        // ==================== PROGRESS BAR UPDATE ====================
        function updateProgressBar(countryId) {
            const country = countries[countryId];
            if (!country) return;

            const percent = (country.moves / CONFIG.maxMoves) * 100;

            const fillEl = document.getElementById(`fill-${countryId}`);
            const textEl = document.getElementById(`text-${countryId}`);

            if (fillEl) {
                const displayWidth = Math.max(15, percent);
                fillEl.style.width = `${Math.min(100, displayWidth)}%`;
            }
            if (textEl) {
                textEl.textContent = `${country.moves}/${CONFIG.maxMoves}`;
            }

            if (country.moves >= CONFIG.maxMoves && !gameState.isVictoryMode) {
                triggerVictory(countryId);
            }
        }

        // ==================== MOVE HANDLERS ====================
        
        // Comment trigger (+1 move)
        function handleComment(countryId, username) {
            if (!countries[countryId] || gameState.isVictoryMode) return;
            
            addMoves(countryId, CONFIG.commentMoves, username);
            addFeedItem(username, 'coment√≥', countryId, 'üí¨', 'comment');
            
            // Quick pulse on the bar
            const card = document.getElementById(`card-${countryId}`);
            if (card) {
                card.style.transform = 'scale(1.03)';
                setTimeout(() => card.style.transform = '', 200);
            }
        }

        // Small gift trigger (+2 moves)
        function handleSmallGift(countryId, username, giftName) {
            if (!countries[countryId] || gameState.isVictoryMode) return;

            const country = countries[countryId];
            addMoves(countryId, CONFIG.smallGiftMoves, username);
            
            // Play epic impact sound
            playGiftImpact();
            
            // Shake the bar
            const card = document.getElementById(`card-${countryId}`);
            if (card) {
                card.classList.add('mega-boost');
                card.style.transform = 'scale(1.08)';
                setTimeout(() => {
                    card.classList.remove('mega-boost');
                    card.style.transform = '';
                }, 500);
            }
            
            showGiftNotification(country.giftImage ? `<img src="${country.giftImage}" style="width:50px;height:50px;object-fit:contain;">` : country.smallEmoji, '+2', 'boost');
            addFeedItem(username, 'regal√≥', countryId, country.smallEmoji, 'gift');
        }

        // MEGA BOOST trigger (+125 moves with EXTREME epic animation)
        function handleMegaBoost(countryId, username, giftName) {
            if (!countries[countryId] || gameState.isVictoryMode) return;

            const country = countries[countryId];
            
            // EPIC visual effects
            const card = document.getElementById(`card-${countryId}`);
            const fillEl = document.getElementById(`fill-${countryId}`);
            const flashEl = document.getElementById('mega-flash');
            const container = document.querySelector('.container');
            
            // Screen shake the whole page!
            if (container) {
                container.classList.add('screen-shake');
                setTimeout(() => container.classList.remove('screen-shake'), 600);
            }
            
            // Screen flash
            if (flashEl) {
                flashEl.classList.add('active');
                setTimeout(() => flashEl.classList.remove('active'), 500);
            }
            
            if (card) {
                card.classList.add('mega-boost');
                setTimeout(() => card.classList.remove('mega-boost'), 1000);
            }
            
            if (fillEl) {
                fillEl.classList.add('boosting');
                setTimeout(() => fillEl.classList.remove('boosting'), 1000);
            }
            
            // Play epic sound
            playBoostSound();
            
            // Add the moves
            addMoves(countryId, CONFIG.boostMoves, username);
            
            showGiftNotification(country.boostEmoji, 'üöÄ ¬°MEGA IMPULSO +125!', 'mega');
            addFeedItem(username, '¬°MEGA IMPULSO!', countryId, country.boostEmoji, 'mega');
        }

        // Core function to add moves and update bar
        function addMoves(countryId, moveCount, username) {
            const country = countries[countryId];
            if (!country) return;

            country.moves = Math.min(CONFIG.maxMoves, country.moves + moveCount);
            
            if (username) {
                country.contributors[username] = (country.contributors[username] || 0) + moveCount;
            }

            gameState.totalActions += moveCount;
            
            // Trigger glow effect based on move size
            const fillEl = document.getElementById(`fill-${countryId}`);
            const card = document.getElementById(`card-${countryId}`);
            
            if (fillEl && !fillEl.classList.contains('boosting')) {
                fillEl.classList.add('moving');
                setTimeout(() => fillEl.classList.remove('moving'), 600);
            }
            
            // Flash the entire bar border on any move
            if (card) {
                card.style.boxShadow = `0 0 20px ${country.glow}, 0 0 40px ${country.glow}`;
                setTimeout(() => card.style.boxShadow = '', 400);
            }
            
            updateProgressBar(countryId);
            updateUI();
            checkLeaderAndCheer();
            
            // Auto-start music on first real event
            tryStartMusic();
        }

        function playBoostSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.4;
                masterGain.connect(audioCtx.destination);
                
                // Epic rising whoosh
                const notes = [200, 300, 400, 550, 700, 900, 1100, 1400, 1700, 2000];
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(masterGain);
                    osc.type = i < 5 ? 'sawtooth' : 'square';
                    osc.frequency.value = freq;
                    const startTime = audioCtx.currentTime + (i * 0.04);
                    gain.gain.setValueAtTime(0.15, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.08);
                    osc.start(startTime);
                    osc.stop(startTime + 0.08);
                });
                
                // Deep bass impact at the end
                setTimeout(() => {
                    const bass = audioCtx.createOscillator();
                    const bassGain = audioCtx.createGain();
                    bass.connect(bassGain);
                    bassGain.connect(masterGain);
                    bass.type = 'sine';
                    bass.frequency.setValueAtTime(60, audioCtx.currentTime);
                    bass.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.4);
                    bassGain.gain.setValueAtTime(0.6, audioCtx.currentTime);
                    bassGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    bass.start();
                    bass.stop(audioCtx.currentTime + 0.4);
                    
                    // Sparkle high notes
                    [2000, 2400, 3000].forEach((f, j) => {
                        const sp = audioCtx.createOscillator();
                        const spG = audioCtx.createGain();
                        sp.connect(spG); spG.connect(masterGain);
                        sp.type = 'sine';
                        sp.frequency.value = f;
                        const t = audioCtx.currentTime + j * 0.08;
                        spG.gain.setValueAtTime(0.1, t);
                        spG.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                        sp.start(t); sp.stop(t + 0.15);
                    });
                }, 350);
            } catch (e) {}
        }
        
        // Epic impact sound for small gifts
        function playGiftImpact() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const gain = audioCtx.createGain();
                gain.connect(audioCtx.destination);
                
                // Quick punch sound
                const osc = audioCtx.createOscillator();
                osc.connect(gain);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.15);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
                
                // Bright ding
                const ding = audioCtx.createOscillator();
                const dingGain = audioCtx.createGain();
                ding.connect(dingGain); dingGain.connect(audioCtx.destination);
                ding.type = 'sine';
                ding.frequency.value = 1200;
                dingGain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                dingGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
                ding.start();
                ding.stop(audioCtx.currentTime + 0.2);
            } catch (e) {}
        }

        function playAlarmSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.1);
                osc.frequency.setValueAtTime(800, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } catch (e) {}
        }

        // ==================== GIFT & COMMENT MATCHING ====================
        
        // Find country from comment text (name or abbreviation)
        function findCountryFromComment(comment) {
            // Normalize: lowercase, remove accents, trim
            const text = comment.toLowerCase().trim()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // strip accents
            
            // Direct keyword matching - much more flexible
            const keywordMap = {
                colombia: ['colombia', 'col', 'colombi'],
                venezuela: ['venezuela', 'ven', 'vene', 'vzla', 'venez'],
                ecuador: ['ecuador', 'ecu', 'ecua'],
                mexico: ['mexico', 'mex', 'mexi', 'mexic'],
                elsalvador: ['el salvador', 'salvador', 'salva', 'sv', 'elsalvador'],
                nicaragua: ['nicaragua', 'nic', 'nicara', 'nica'],
                guatemala: ['guatemala', 'gua', 'guate', 'chapines', 'chapin'],
                peru: ['peru', 'per', 'peruano'],
                puertorico: ['puerto rico', 'puertorico', 'pr', 'boricua', 'borinquen'],
                dominicana: ['dominicana', 'dominican', 'dom', 'rd', 'quisqueya', 'republica dominicana', 'rep dominicana', 'rep. dominicana'],
                chile: ['chile', 'chi', 'chileno', 'chilena'],
                trump: ['usa', 'us', 'united states', 'trump', 'estados unidos', 'eeuu', 'america', 'gringo']
            };
            
            for (const [countryId, keywords] of Object.entries(keywordMap)) {
                for (const kw of keywords) {
                    // Check if the keyword appears anywhere in the text
                    if (text.includes(kw)) {
                        // For very short keywords (2 chars), require exact match or start/end
                        if (kw.length <= 2) {
                            if (text === kw || text.startsWith(kw + ' ') || text.endsWith(' ' + kw) || text.includes(' ' + kw + ' ') || text.includes('#' + kw)) {
                                return countryId;
                            }
                        } else {
                            return countryId;
                        }
                    }
                }
            }
            return null;
        }

        // Find country and gift type from gift name/id
        function findCountryForGift(giftName, giftId) {
            const name = (giftName || '').toLowerCase().trim();
            const id = (giftId || '').toString().trim();

            for (const [countryId, country] of Object.entries(countries)) {
                // Check small gifts (1-coin = 2 moves)
                for (const g of country.smallGifts) {
                    if ((name && (name.includes(g) || g.includes(name))) ||
                        (id && id === g)) {
                        return { countryId, type: 'small' };
                    }
                }
                // Check boost gifts (100-coin = 125 moves)
                for (const g of country.boostGifts) {
                    if ((name && (name.includes(g) || g.includes(name))) ||
                        (id && id === g)) {
                        return { countryId, type: 'boost' };
                    }
                }
            }
            return null;
        }

        // ==================== VICTORY ====================
        function triggerVictory(countryId) {
            const country = countries[countryId];
            gameState.isVictoryMode = true;

            let topContributor = 'Anonymous';
            let maxContributions = 0;
            Object.entries(country.contributors).forEach(([name, count]) => {
                if (count > maxContributions) {
                    maxContributions = count;
                    topContributor = name;
                }
            });

            gameState.dailyWins[countryId] = (gameState.dailyWins[countryId] || 0) + 1;
            saveDailyWins();

            document.getElementById('victory-image').src = country.image;
            document.getElementById('victory-country').textContent = country.name;
            document.getElementById('victory-contributor').textContent = `Mejor jugador: ${topContributor}`;
            document.getElementById('victory-overlay').classList.add('active');

            startFireworks();
            
            // Epic victory cheers - play 3 times
            speakCheer(countryId, true);
            setTimeout(() => speakCheer(countryId, true), 3000);
            setTimeout(() => speakCheer(countryId, true), 6000);

            let countdown = 10;
            const timerEl = document.getElementById('victory-timer');
            const interval = setInterval(() => {
                countdown--;
                timerEl.textContent = `Nueva ronda en ${countdown}s`;
                if (countdown <= 0) {
                    clearInterval(interval);
                    resetRound();
                }
            }, 1000);
        }

        function resetRound() {
            document.getElementById('victory-overlay').classList.remove('active');
            stopFireworks();

            Object.keys(countries).forEach(id => {
                countries[id].moves = 0;
                countries[id].contributors = {};
                updateProgressBar(id);
            });

            gameState.roundNumber++;
            gameState.isVictoryMode = false;
            gameState.currentLeader = null;
            updateUI();
        }

        // ==================== FIREWORKS ====================
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const fireworksCtx = fireworksCanvas.getContext('2d');
        let fireworks = [], particles = [], fireworksRunning = false;

        function resizeFireworks() {
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeFireworks);
        resizeFireworks();

        function startFireworks() {
            fireworksRunning = true;
            animateFireworks();
            const launch = setInterval(() => {
                if (!fireworksRunning) { clearInterval(launch); return; }
                fireworks.push({
                    x: Math.random() * fireworksCanvas.width,
                    y: fireworksCanvas.height,
                    targetY: 100 + Math.random() * 300,
                    speed: 6 + Math.random() * 4,
                    color: `hsl(${Math.random() * 360}, 100%, 60%)`
                });
            }, 200);
        }

        function stopFireworks() {
            fireworksRunning = false;
            fireworks = [];
            particles = [];
            fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
        }

        function animateFireworks() {
            if (!fireworksRunning) return;
            fireworksCtx.fillStyle = 'rgba(0,0,0,0.15)';
            fireworksCtx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);

            fireworks = fireworks.filter(f => {
                f.y -= f.speed;
                fireworksCtx.beginPath();
                fireworksCtx.arc(f.x, f.y, 3, 0, Math.PI * 2);
                fireworksCtx.fillStyle = f.color;
                fireworksCtx.fill();

                if (f.y <= f.targetY) {
                    for (let i = 0; i < 40; i++) {
                        const angle = (Math.PI * 2 / 40) * i;
                        particles.push({
                            x: f.x, y: f.y,
                            vx: Math.cos(angle) * (2 + Math.random() * 3),
                            vy: Math.sin(angle) * (2 + Math.random() * 3),
                            color: f.color, life: 1
                        });
                    }
                    return false;
                }
                return true;
            });

            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.08;
                p.life -= 0.02;
                fireworksCtx.globalAlpha = p.life;
                fireworksCtx.beginPath();
                fireworksCtx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                fireworksCtx.fillStyle = p.color;
                fireworksCtx.fill();
                fireworksCtx.globalAlpha = 1;
                return p.life > 0;
            });

            requestAnimationFrame(animateFireworks);
        }

        // ==================== DECAY ====================
        function startDecay() {
            setInterval(() => {
                if (gameState.isVictoryMode) return;
                Object.keys(countries).forEach(id => {
                    if (countries[id].fillPercent > 0) {
                        updateProgressBar(id, countries[id].fillPercent - CONFIG.decayAmount);
                    }
                });
                updateUI();
            }, CONFIG.decayInterval);

            setInterval(() => {
                gameState.decayTimer--;
                if (gameState.decayTimer <= 0) gameState.decayTimer = 15;
                document.getElementById('decay-timer').textContent = `${gameState.decayTimer}s`;
            }, 1000);
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            document.getElementById('round-number').textContent = gameState.roundNumber;
            document.getElementById('total-actions').textContent = gameState.totalActions;
            updateLeaderboard();
            updateCardWins();
        }

        function updateCardWins() {
            Object.keys(countries).forEach(id => {
                const el = document.getElementById(`wins-${id}`);
                if (el) el.textContent = `${gameState.dailyWins[id] || 0}üèÜ`;
            });
        }

        function updateLeaderboard() {
            const list = document.getElementById('ranking-list');
            const sorted = Object.entries(countries)
                .map(([id, c]) => ({ id, ...c, wins: gameState.dailyWins[id] || 0 }))
                .sort((a, b) => b.wins !== a.wins ? b.wins - a.wins : b.moves - a.moves);

            list.innerHTML = sorted.map((c, i) => `
                <div class="ranking-item" style="--rank-color: ${c.color}; --rank-glow: ${c.glow}">
                    <div class="rank-badge ${i < 3 ? `rank-${i + 1}` : 'rank-other'}">${i + 1}</div>
                    <img class="ranking-image" src="${c.image}" alt="${c.name}" onerror="this.src='https://flagcdn.com/w80/un.png'">
                    <div class="ranking-info">
                        <div class="ranking-name">${c.name}</div>
                        <div class="ranking-percent">${c.moves}/${CONFIG.maxMoves} movimientos</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="ranking-wins">${c.wins}</div>
                        <div class="ranking-wins-label">victorias</div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== FEED & NOTIFICATIONS ====================
        function addFeedItem(user, action, countryId, emoji, type) {
            const feed = document.getElementById('activity-feed');
            const country = countries[countryId];
            const item = document.createElement('div');
            item.className = `feed-item ${type}`;
            item.innerHTML = `
                <span class="feed-emoji">${emoji}</span>
                <span class="feed-user">${user}</span>
                <span class="feed-action">${action}</span>
                <span class="feed-target">${country.flag} ${country.name}</span>
            `;
            feed.insertBefore(item, feed.firstChild);
            while (feed.children.length > 5) feed.removeChild(feed.lastChild);
            setTimeout(() => { if (item.parentNode) item.remove(); }, 6000);
        }

        function showGiftNotification(emoji, text, type) {
            const notif = document.createElement('div');
            notif.className = `gift-notification ${type}`;
            notif.innerHTML = `<span class="emoji">${emoji}</span>${text}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 1200);
        }

        // ==================== WEBSOCKET ====================
        function connectWebSocket() {
            const statusEl = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            statusEl.className = 'connection-status connecting';
            statusText.textContent = 'Connecting...';

            try {
                gameState.ws = new WebSocket(CONFIG.wsUrl);
                gameState.ws.onopen = () => {
                    gameState.connected = true;
                    statusEl.className = 'connection-status connected';
                    statusText.textContent = 'Connected';
                };
                gameState.ws.onclose = () => {
                    gameState.connected = false;
                    statusEl.className = 'connection-status disconnected';
                    statusText.textContent = 'Disconnected';
                    setTimeout(connectWebSocket, 5000);
                };
                gameState.ws.onerror = () => {
                    statusEl.className = 'connection-status disconnected';
                    statusText.textContent = 'Error';
                };
                gameState.ws.onmessage = (e) => {
                    try {
                        processMessage(JSON.parse(e.data));
                    } catch (err) {}
                };
            } catch (e) {
                statusEl.className = 'connection-status disconnected';
                statusText.textContent = 'Failed';
                setTimeout(connectWebSocket, 5000);
            }
        }

        function processMessage(data) {
            const username = data.uniqueId || data.nickname || 'Anonymous';
            
            console.log('üì® Received:', JSON.stringify(data).substring(0, 200));
            
            // Handle comments - check for country name/abbreviation
            if (data.type === 'chat' || data.comment) {
                const comment = data.comment || data.text || '';
                console.log(`üí¨ Comment from ${username}: "${comment}"`);
                const countryId = findCountryFromComment(comment);
                if (countryId) {
                    console.log(`‚úÖ Matched country: ${countryId}`);
                    handleComment(countryId, username);
                } else {
                    console.log(`‚ùå No country match for: "${comment}"`);
                }
            }
            
            // Handle gifts
            if (data.type === 'gift' || data.giftName || data.giftId) {
                const giftName = data.giftName || data.gift || data.extendedGiftInfo?.name || '';
                const giftId = data.giftId || data.gift_id || '';
                console.log(`üéÅ Gift from ${username}: "${giftName}" (ID: ${giftId})`);
                
                const match = findCountryForGift(giftName, giftId);
                if (match) {
                    console.log(`‚úÖ Gift matched: ${match.countryId} (${match.type})`);
                    if (match.type === 'small') {
                        handleSmallGift(match.countryId, username, giftName);
                    } else if (match.type === 'boost') {
                        handleMegaBoost(match.countryId, username, giftName);
                    }
                } else {
                    console.log(`‚ùå No gift match for: "${giftName}" (ID: ${giftId})`);
                }
            }

            // Handle likes - give +1 move to current leader or random country
            if (data.type === 'like') {
                const countryIds = Object.keys(countries);
                let targetCountry;
                let maxMoves = 0;
                countryIds.forEach(id => {
                    if (countries[id].moves > maxMoves) {
                        maxMoves = countries[id].moves;
                        targetCountry = id;
                    }
                });
                if (!targetCountry || maxMoves === 0) {
                    targetCountry = countryIds[Math.floor(Math.random() * countryIds.length)];
                }
                addMoves(targetCountry, CONFIG.commentMoves, username);
                addFeedItem(username, '‚ù§Ô∏è le dio like', targetCountry, '‚ù§Ô∏è', 'comment');
            }
        }

        // ==================== CONTROLS ====================
        function testAction(action) {
            if (!gameState.selectedCountry) {
                showGiftNotification('üëÜ', 'Select a country!', 'boost');
                return;
            }
            const user = 'Tester_' + Math.floor(Math.random() * 1000);
            const country = countries[gameState.selectedCountry];
            if (navigator.vibrate) navigator.vibrate(action === 'mega' ? [50, 30, 50, 30, 50] : 30);

            if (action === 'comment') {
                handleComment(gameState.selectedCountry, user);
            } else if (action === 'small') {
                handleSmallGift(gameState.selectedCountry, user, country.smallGifts[0]);
            } else if (action === 'mega') {
                handleMegaBoost(gameState.selectedCountry, user, country.boostGifts[0]);
            }
        }

        function togglePanel() {
            const panel = document.getElementById('control-panel');
            const btn = document.getElementById('toggle-btn');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? '+' : '‚àí';
        }

        function startDemoMode() {
            if (gameState.demoInterval) {
                clearInterval(gameState.demoInterval);
                gameState.demoInterval = null;
                showGiftNotification('‚èπÔ∏è', 'Stopped', 'sabotage');
                return;
            }
            showGiftNotification('‚ñ∂Ô∏è', 'Demo!', 'boost');
            gameState.demoInterval = setInterval(() => {
                if (gameState.isVictoryMode) return;
                const ids = Object.keys(countries);
                const id = ids[Math.floor(Math.random() * ids.length)];
                const users = ['Fan1', 'Pro2', 'Gift3', 'Star4', 'King5', 'Viewer6'];
                const user = users[Math.floor(Math.random() * users.length)];
                
                const rand = Math.random();
                if (rand < 0.5) {
                    // 50% chance: comment
                    handleComment(id, user);
                } else if (rand < 0.9) {
                    // 40% chance: small gift
                    handleSmallGift(id, user, countries[id].smallGifts[0]);
                } else {
                    // 10% chance: mega boost
                    handleMegaBoost(id, user, countries[id].boostGifts[0]);
                }
            }, 300);
        }

        function clearAllWins() {
            if (confirm('Clear all wins?')) {
                gameState.dailyWins = {};
                saveDailyWins();
                updateUI();
                showGiftNotification('üóëÔ∏è', 'Cleared', 'sabotage');
            }
        }

        // ==================== SECRET TEST PANEL TOGGLE ====================
        // Press T key to show/hide test controls (hidden from viewers by default)
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                const panel = document.getElementById('control-panel');
                panel.classList.toggle('visible');
            }
        });

        // ==================== BATTLE MUSIC SYSTEM ====================
        const BattleMusic = {
            ctx: null,
            playing: false,
            currentTrack: 0,
            masterGain: null,
            nodes: [],
            bpm: 140,
            
            // 3 different battle tracks
            tracks: [
                { // Track 1: Aggressive EDM Battle
                    bpm: 140,
                    bassPattern: [0, 0, 7, 5, 0, 0, 3, 7, 0, 0, 7, 5, 3, 5, 7, 3],
                    leadPattern: [12, 15, 19, 17, 15, 12, 14, 15, 12, 15, 19, 22, 19, 17, 15, 14],
                    leadOctave: 1,
                    bassOctave: -1,
                    padChords: [[0,4,7], [5,9,12], [3,7,10], [7,11,14]],
                    drumPattern: [1,0,0,1, 1,0,1,0, 1,0,0,1, 1,0,1,1],
                    hihatPattern:[1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
                    key: 36, // C2 MIDI
                    filterFreq: 800,
                    vibe: 'aggressive'
                },
                { // Track 2: Epic Cinematic Battle
                    bpm: 128,
                    bassPattern: [0, 0, 0, 5, 7, 7, 5, 3, 0, 0, 0, 5, 3, 3, 5, 7],
                    leadPattern: [24, 22, 19, 17, 19, 22, 24, 26, 24, 22, 19, 15, 17, 19, 22, 24],
                    leadOctave: 1,
                    bassOctave: -1,
                    padChords: [[0,3,7], [5,8,12], [7,10,14], [3,7,10]],
                    drumPattern: [1,0,0,0, 1,0,0,1, 1,0,0,0, 1,0,1,0],
                    hihatPattern:[0,1,1,1, 0,1,1,1, 0,1,1,1, 1,1,1,1],
                    key: 33, // A1 MIDI
                    filterFreq: 600,
                    vibe: 'epic'
                },
                { // Track 3: Fast Hype Battle
                    bpm: 155,
                    bassPattern: [0, 3, 5, 7, 0, 3, 7, 5, 0, 5, 7, 10, 7, 5, 3, 0],
                    leadPattern: [12, 14, 15, 19, 17, 15, 14, 12, 15, 17, 19, 22, 19, 17, 15, 12],
                    leadOctave: 2,
                    bassOctave: -1,
                    padChords: [[0,4,7], [3,7,10], [5,9,12], [0,4,7]],
                    drumPattern: [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,1,1,0],
                    hihatPattern:[1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
                    key: 38, // D2 MIDI
                    filterFreq: 1000,
                    vibe: 'hype'
                }
            ],
            
            midiToFreq(midi) {
                return 440 * Math.pow(2, (midi - 69) / 12);
            },
            
            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.3;
                
                // Master compressor for loudness
                const compressor = this.ctx.createDynamicsCompressor();
                compressor.threshold.value = -20;
                compressor.knee.value = 10;
                compressor.ratio.value = 8;
                compressor.attack.value = 0.005;
                compressor.release.value = 0.1;
                
                this.masterGain.connect(compressor);
                compressor.connect(this.ctx.destination);
            },
            
            createKick(time) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(30, time + 0.15);
                gain.gain.setValueAtTime(0.8, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start(time);
                osc.stop(time + 0.2);
            },
            
            createHihat(time) {
                const bufferSize = this.ctx.sampleRate * 0.05;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 3);
                }
                const source = this.ctx.createBufferSource();
                source.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.15, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 7000;
                source.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);
                source.start(time);
            },
            
            createSnare(time) {
                // Noise part
                const bufferSize = this.ctx.sampleRate * 0.1;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
                }
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const noiseGain = this.ctx.createGain();
                noiseGain.gain.setValueAtTime(0.4, time);
                noiseGain.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                const noiseFilter = this.ctx.createBiquadFilter();
                noiseFilter.type = 'bandpass';
                noiseFilter.frequency.value = 3000;
                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(this.masterGain);
                noise.start(time);
                
                // Tone part
                const osc = this.ctx.createOscillator();
                const oscGain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, time);
                osc.frequency.exponentialRampToValueAtTime(80, time + 0.05);
                oscGain.gain.setValueAtTime(0.3, time);
                oscGain.gain.exponentialRampToValueAtTime(0.001, time + 0.08);
                osc.connect(oscGain);
                oscGain.connect(this.masterGain);
                osc.start(time);
                osc.stop(time + 0.1);
            },
            
            playTrack(trackIdx) {
                if (!this.ctx) this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                this.stopAll();
                const track = this.tracks[trackIdx];
                this.bpm = track.bpm;
                const stepTime = 60 / track.bpm / 4; // 16th notes
                const barLength = 16 * stepTime;
                const loopLength = 4 * barLength; // 4 bars per loop
                
                const now = this.ctx.currentTime + 0.1;
                
                // Schedule 8 loops ahead (then re-schedule)
                const totalBars = 32;
                
                for (let bar = 0; bar < totalBars; bar++) {
                    const barStart = now + (bar * barLength);
                    const chordIdx = bar % 4;
                    
                    // Bass
                    for (let step = 0; step < 16; step++) {
                        const time = barStart + step * stepTime;
                        const note = track.bassPattern[step];
                        if (note !== null) {
                            const freq = this.midiToFreq(track.key + note + (12 * track.bassOctave));
                            this.playBass(freq, time, stepTime * 0.8);
                        }
                        
                        // Drums
                        if (track.drumPattern[step]) {
                            if (step % 8 === 4) {
                                this.createSnare(time);
                            } else {
                                this.createKick(time);
                            }
                        }
                        if (track.hihatPattern[step]) {
                            this.createHihat(time);
                        }
                    }
                    
                    // Lead melody
                    for (let step = 0; step < 16; step++) {
                        const time = barStart + step * stepTime;
                        const note = track.leadPattern[step];
                        if (note !== null && step % 2 === 0) {
                            const freq = this.midiToFreq(track.key + note + (12 * track.leadOctave));
                            this.playLead(freq, time, stepTime * 1.8, track.filterFreq);
                        }
                    }
                    
                    // Pad chords
                    const chord = track.padChords[chordIdx];
                    chord.forEach(note => {
                        const freq = this.midiToFreq(track.key + note + 24);
                        this.playPad(freq, barStart, barLength * 0.95);
                    });
                }
                
                // Schedule next track when this one ends
                const totalTime = totalBars * barLength;
                this.nextTrackTimeout = setTimeout(() => {
                    if (this.playing) {
                        this.currentTrack = (this.currentTrack + 1) % this.tracks.length;
                        this.playTrack(this.currentTrack);
                    }
                }, totalTime * 1000);
                
                this.playing = true;
            },
            
            playBass(freq, time, duration) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, time);
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(400, time);
                filter.Q.value = 5;
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.35, time + 0.01);
                gain.gain.setValueAtTime(0.35, time + duration * 0.7);
                gain.gain.linearRampToValueAtTime(0, time + duration);
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);
                osc.start(time);
                osc.stop(time + duration + 0.01);
            },
            
            playLead(freq, time, duration, filterFreq) {
                const osc1 = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                osc1.type = 'square';
                osc2.type = 'sawtooth';
                osc1.frequency.setValueAtTime(freq, time);
                osc2.frequency.setValueAtTime(freq * 1.005, time); // slight detune
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(filterFreq, time);
                filter.frequency.linearRampToValueAtTime(filterFreq * 3, time + 0.05);
                filter.frequency.exponentialRampToValueAtTime(filterFreq, time + duration);
                filter.Q.value = 3;
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.12, time + 0.02);
                gain.gain.setValueAtTime(0.1, time + duration * 0.6);
                gain.gain.linearRampToValueAtTime(0, time + duration);
                osc1.connect(filter);
                osc2.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);
                osc1.start(time);
                osc2.start(time);
                osc1.stop(time + duration + 0.01);
                osc2.stop(time + duration + 0.01);
            },
            
            playPad(freq, time, duration) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, time);
                filter.type = 'lowpass';
                filter.frequency.value = 1200;
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.06, time + duration * 0.3);
                gain.gain.setValueAtTime(0.06, time + duration * 0.7);
                gain.gain.linearRampToValueAtTime(0, time + duration);
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);
                osc.start(time);
                osc.stop(time + duration + 0.05);
            },
            
            stopAll() {
                if (this.nextTrackTimeout) clearTimeout(this.nextTrackTimeout);
                // Create fresh gain to kill all sound
                if (this.ctx && this.masterGain) {
                    this.masterGain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.1);
                    setTimeout(() => {
                        if (this.masterGain) this.masterGain.gain.value = 0.3;
                    }, 150);
                }
            },
            
            start() {
                if (!this.ctx) this.init();
                this.currentTrack = 0;
                this.playTrack(0);
            },
            
            stop() {
                this.playing = false;
                this.stopAll();
            },
            
            toggle() {
                if (this.playing) {
                    this.stop();
                } else {
                    this.start();
                }
                return this.playing;
            }
        };
        
        // Auto-start music on first user interaction (browser requires gesture)
        let musicStarted = false;
        function tryStartMusic() {
            if (!musicStarted) {
                musicStarted = true;
                BattleMusic.start();
                console.log('üéµ Battle music started!');
            }
        }
        document.addEventListener('click', tryStartMusic, { once: false });
        document.addEventListener('touchstart', tryStartMusic, { once: false });
        document.addEventListener('keydown', tryStartMusic, { once: false });
        
        // Also try to auto-start after a short delay (some browsers allow it)
        setTimeout(() => {
            try {
                tryStartMusic();
            } catch(e) {}
        }, 2000);
        
        // M key to toggle music
        document.addEventListener('keydown', (e) => {
            if (e.key === 'm' || e.key === 'M') {
                const playing = BattleMusic.toggle();
                console.log(playing ? 'üéµ Music ON' : 'üîá Music OFF');
            }
        });

        // ==================== INIT ====================
        function init() {
            createCountryCards();
            updateUI();
            connectWebSocket();
            startDecay();
            startCheerSystem();
            console.log('‚öîÔ∏è Scribble War Progress Bars Ready!');
            console.log('üîä Spanish cheers enabled - tap üîä to mute');
        }

        init();
    </script>
</body>
</html>
